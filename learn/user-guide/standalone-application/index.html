<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=generator content="Wowchemy 5.3.0 for Hugo">
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap">
<link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" media=print onload="this.media='all'">
<meta name=description content="How to develop an end-user standalone application.">
<link rel=alternate hreflang=en-us href=https://keyple.org/learn/user-guide/standalone-application/>
<meta name=theme-color content="#1D87BB">
<link rel=stylesheet href=../../../css/vendor-bundle.min.f1ecf783c14edc00c9320c205831ad8e.css media=print onload="this.media='all'">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin=anonymous media=print onload="this.media='all'">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/darcula.min.css crossorigin=anonymous title=hl-light media=print onload="this.media='all'">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/darcula.min.css crossorigin=anonymous title=hl-dark media=print onload="this.media='all'" disabled>
<link rel=stylesheet href=../../../css/wowchemy.17c9be48a5d4415ce96a90ae1a222279.css>
<script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-5WLCZXC')</script>
<link rel=manifest href=../../../manifest.webmanifest>
<link rel=icon type=image/png href=../../../media/icon_hu16db34b3636b127457de39ca2fab620f_9845_32x32_fill_lanczos_center_3.png>
<link rel=apple-touch-icon type=image/png href=../../../media/icon_hu16db34b3636b127457de39ca2fab620f_9845_180x180_fill_lanczos_center_3.png>
<link rel=canonical href=https://keyple.org/learn/user-guide/standalone-application/>
<meta property="twitter:card" content="summary">
<meta property="og:site_name" content="Eclipse Keyple">
<meta property="og:url" content="https://keyple.org/learn/user-guide/standalone-application/">
<meta property="og:title" content="Standalone Application User Guide | Eclipse Keyple">
<meta property="og:description" content="How to develop an end-user standalone application."><meta property="og:image" content="https://keyple.org/media/logo.svg">
<meta property="twitter:image" content="https://keyple.org/media/logo.svg"><meta property="og:locale" content="en-us">
<meta property="article:modified_time" content="2022-07-26T16:25:33+02:00">
<title>Standalone Application User Guide | Eclipse Keyple</title>
</head>
<body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=e77ca063ee6572d6bf15d5656980094d>
<script src=../../../js/wowchemy-init.min.da42964e270e05a6063fbca894d7ccff.js></script>
<aside class=search-modal id=search>
<div class=container>
<section class=search-header>
<div class="row no-gutters justify-content-between mb-3">
<div class=col-6>
<h1>Search</h1>
</div>
<div class="col-6 col-search-close">
<a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a>
</div>
</div>
<div id=search-box>
<input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...>
</div>
</section>
<section class=section-search-results>
<div id=search-hits>
</div>
</section>
</div>
</aside>
<div class=page-header>
<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main>
<div class=container-xl>
<div class="d-none d-lg-inline-flex">
<a class=navbar-brand href=../../../><img src=../../../media/logo.svg alt="Eclipse Keyple"></a>
</div>
<button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span>
</button>
<div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
<a class=navbar-brand href=../../../><img src=../../../media/logo.svg alt="Eclipse Keyple"></a>
</div>
<div class="navbar-collapse main-menu-item collapse justify-content-center" id=navbar-content>
<ul class="navbar-nav d-md-inline-flex">
<li class="nav-item dropdown">
<a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>What is Eclipse Keyple®</span><span class=caret></span>
</a>
<div class=dropdown-menu>
<a class=dropdown-item href=../../../what-is-keyple/overview/><span>Overview</span></a>
<a class=dropdown-item href=../../../what-is-keyple/why-trust/><span>Why trust Eclipse Keyple®?</span></a>
<a class=dropdown-item href=../../../what-is-keyple/who-is-it-for/><span>Who is it for?</span></a>
<a class=dropdown-item href=../../../#adopters><span>Who is using Eclipse Keyple®?</span></a>
<a class=dropdown-item href=../../../what-is-keyple/what-is-calypso/><span>What is Calypso®?</span></a>
<a class=dropdown-item href=../../../what-is-keyple/main-features/><span>Keyple's main features</span></a>
<a class=dropdown-item href=../../../#news><span>News</span></a>
</div>
</li>
<li class=nav-item>
<a class=nav-link href=../../../learn/overview><span>Learn</span></a>
</li>
<li class="nav-item dropdown">
<a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>Components</span><span class=caret></span>
</a>
<div class=dropdown-menu>
<a class=dropdown-item href=../../../components-java/overview/><span>Java implementation v2+</span></a>
<a class=dropdown-item href=../../../components-cpp/overview/><span>C++ implementation v2+</span></a>
<a class=dropdown-item href=../../../><span> </span></a>
<a class=dropdown-item href=../../../learn/user-guide/migrate-to-2-0><span>Guide to migrate from v1.0 to v2+</span></a>
<a class=dropdown-item href=../../../components-java-1.0/><span>Java implementation v1.0 (deprecated)</span></a>
<a class=dropdown-item href=../../../components-cpp-0.9/><span>C++ implementation v0.9 (deprecated)</span></a>
</div>
</li>
<li class="nav-item dropdown">
<a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>Community</span><span class=caret></span>
</a>
<div class=dropdown-menu>
<a class=dropdown-item href=../../../community/contributing/><span>Contributing</span></a>
<a class=dropdown-item href=../../../community/roadmap/><span>Roadmap</span></a>
<a class=dropdown-item href=../../../projects-dashboard/><span>Projects dashboard</span></a>
<a class=dropdown-item href="https://sonarcloud.io/organizations/eclipse/projects?search=keyple&sort=-analysis_date"><span>Code quality dashboard</span></a>
<a class=dropdown-item href=https://projects.eclipse.org/projects/iot.keyple/><span>Eclipse Foundation Keyple page</span></a>
<a class=dropdown-item href=https://accounts.eclipse.org/mailing-list/keyple-dev/><span>Mailing list</span></a>
<a class=dropdown-item href=https://github.com/eclipse/keyple/><span>GitHub home repository</span></a>
</div>
</li>
<li class="nav-item dropdown">
<a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>External resources</span><span class=caret></span>
</a>
<div class=dropdown-menu>
<a class=dropdown-item href=../../../external-resources/external-add-ons/><span>External add-ons</span></a>
<a class=dropdown-item href=../../../external-resources/compliant-terminals/><span>Compliant terminals</span></a>
<a class=dropdown-item href=../../../external-resources/support-and-training-companies/><span>Support & training companies</span></a>
</div>
</li>
</ul>
</div>
<ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
<li class=nav-item>
<a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a>
</li>
</ul>
</div>
</nav>
</div>
<div class=page-body>
<div class="container-fluid docs">
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 docs-sidebar">
<form class="docs-search d-flex align-items-center">
<button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation">
<div class=d-flex>
<span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">
User guides
</span>
<span><i class="fas fa-chevron-down"></i></span>
</div>
</button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>Search...</span>
<span class=sidebar-search-shortcut>/</span>
</button>
</form>
<nav class="collapse docs-links" id=docs-nav>
<ul class="nav docs-sidenav">
<li><a href=../../../learn/></a></li>
<div class=docs-toc-item>
<a class=docs-toc-link href=../../../learn/overview/>Overview</a>
<ul class="nav docs-sidenav">
<li><a href=../../../learn/overview/key-concepts/>Key concepts</a></li>
<li><a href=../../../learn/overview/architecture/>Architecture</a></li>
<li><a href=../../../learn/overview/terminalapis/>Calypso Terminal APIs</a></li>
</ul>
</div>
<div class=docs-toc-item>
<a class=docs-toc-link href=../../../learn/build-your-first-app/>Build your first app</a>
<ul class="nav docs-sidenav">
<li><a href=../../../learn/build-your-first-app/java-app/>Java</a></li>
<li><a href=../../../learn/build-your-first-app/android-app/>Android</a></li>
<li><a href=../../../learn/build-your-first-app/cpp-app/>C++</a></li>
</ul>
</div>
<div class=docs-toc-item>
<a class=docs-toc-link href=../../../learn/user-guide/>User guides</a>
<ul class="nav docs-sidenav">
<li class=active><a href=../../../learn/user-guide/standalone-application/>Standalone application</a></li>
<li><a href=../../../learn/user-guide/distributed-application/>Distributed application</a></li>
<li><a href=../../../learn/user-guide/calypso-application/>Calypso application</a></li>
<li><a href=../../../learn/user-guide/card-resource-service/>Card resource service</a></li>
<li><a href=../../../learn/user-guide/migrate-to-2-0/>Upgrade Keyple</a></li>
</ul>
</div>
<div class=docs-toc-item>
<a class=docs-toc-link href=../../../learn/developer-guide/>Developer guides</a>
<ul class="nav docs-sidenav">
<li><a href=../../../learn/developer-guide/reader-plugin-add-on/>Reader plugin add-on</a></li>
<li><a href=../../../learn/developer-guide/card-extension-add-on/>Card extension add-on</a></li>
</ul>
</div>
<div class=docs-toc-item>
<a class=docs-toc-link href=../../../learn/example-code/>Example code</a>
<ul class="nav docs-sidenav">
<li><a href=../../../learn/example-code/java-example/>Java examples</a></li>
<li><a href=../../../learn/example-code/cpp-example/>C++ examples</a></li>
</ul>
</div>
<div class=docs-toc-item>
<a class=docs-toc-link href=../../../learn/keyple-in-depth/>Keyple in depth</a>
<ul class="nav docs-sidenav">
<li><a href=../../../learn/keyple-in-depth/core-services/>Core services</a></li>
<li><a href=../../../learn/keyple-in-depth/calypso-card-extension/>Calypso card extension</a></li>
<li><a href=../../../learn/keyple-in-depth/build-and-ci/>Build and CI</a></li>
</ul>
</div>
</ul>
</nav>
</div>
<div class="d-none d-xl-block col-xl-2 docs-toc">
<ul class="nav toc-top">
<li><a href=# id=back_to_top class=docs-toc-title>Contents</a></li>
</ul>
<nav id=TableOfContents>
<ul>
<li><a href=#overview>Overview</a></li>
<li><a href=#operating-mode>Operating mode</a></li>
<li><a href=#the-smart-card-service>The smart card service</a></li>
<li><a href=#set-up-a-plugin>Set up a plugin</a>
<ul>
<li><a href=#access-to-a-plugin>Access to a plugin</a></li>
<li><a href=#configure-a-plugin>Configure a plugin</a></li>
<li><a href=#monitor-a-plugin>Monitor a plugin</a></li>
</ul>
</li>
<li><a href=#set-up-a-reader>Set up a reader</a>
<ul>
<li><a href=#access-to-a-reader>Access to a reader</a></li>
<li><a href=#configure-a-reader>Configure a reader</a></li>
<li><a href=#monitor-a-reader>Monitor a reader</a></li>
</ul>
</li>
<li><a href=#select-a-card>Select a card</a>
<ul>
<li><a href=#prepare-a-scenario>Prepare a scenario</a></li>
<li><a href=#run-a-scenario>Run a scenario</a></li>
<li><a href=#schedule-a-scenario>Schedule a scenario</a></li>
</ul>
</li>
<li><a href=#perform-a-transaction>Perform a transaction</a></li>
<li><a href=#unregister-a-plugin>Unregister a plugin</a></li>
<li><a href=#api>API</a></li>
<li><a href=#examples>Examples</a></li>
<li><a href=#download>Download</a></li>
</ul>
</nav>
</div>
<main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role=main>
<article class=article>
<div class=docs-article-container>
<h1>Standalone Application User Guide</h1>
<div class=article-style>
<hr>
<h2 id=overview>Overview</h2>
<p>A standalone application is an application that runs in a device in contact
with the end user.</p>
<p>It has at least one local smart card reader and manages itself the
interaction with the user.</p>
<p>The diagram below illustrates the organization of a standalone application based on Keyple:
<figure>
<div class="d-flex justify-content-center">
<div class=w-100><img src=../../../media/learn/user-guide/standalone-application/standalone_application_overview.svg alt loading=lazy data-zoomable></div>
</div></figure></p>
<hr>
<h2 id=operating-mode>Operating mode</h2>
<div class="alert alert-warning">
<div>
If you are new to Keyple, read the <a href=../../../learn/overview/key-concepts/>key concepts</a> page and familiarize yourself with the fundamentals behind Keyple.
</div>
</div>
<ol>
<li>Access to the <a href=#the-smart-card-service>smart card service</a></li>
<li><a href=#set-up-a-plugin>Set up a plugin</a></li>
<li><a href=#set-up-a-reader>Set up a reader</a></li>
<li><a href=#select-a-card>Select a card</a></li>
<li><a href=#perform-a-transaction>Perform a transaction</a></li>
</ol>
<h2 id=the-smart-card-service>The smart card service</h2>
<p>As part of Keyple Service component, the smart card service is the main service of Keyple. Its role is to centralize the add-on resources and to manage their
life cycle.</p>
<p>The service is accessible by invoking the <code>SmartCardServiceProvider.getService()</code> static method.</p>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('2',this)">Copy</button></div>
<pre><code class=language-java id=code-2>SmartCardService smartCardService = SmartCardServiceProvider.getService();</code></pre>
<hr>
<h2 id=set-up-a-plugin>Set up a plugin</h2>
<p>The Keyple application developer will choose the reader plugins he needs
according to the equipment on which the Keyple application will run.</p>
<p>For example, if the environment is PC-based, the PC/SC plugin will probably, but not necessarily, be chosen.
For an Andoid terminal environment, the plugin could be the standard
Android NFC plugin or one of the plugins available from the industrial
partners of the project.</p>
<p>For a complete list of available plugins, please see
the <a href=https://keyple.org/components-java/standard-reader-plugins/>standard reader plugins</a>,
the <a href=https://keyple.org/components-java/specific-reader-plugins/>specific reader plugins</a>
or one of our <a href=https://keyple.org/external-resources/external-add-ons/>partners reader plugins</a>.</p>
<div class="alert alert-note">
<div>
A new plugin can also be <a href=../../../learn/developer-guide/reader-plugin-add-on/>created</a> if there is no plugin for the intended hardware.
</div>
</div>
<h3 id=access-to-a-plugin>Access to a plugin</h3>
<p>To access a plugin at the application level, it must first be registered with the smart card service via the <code>registerPlugin(...)</code> method.
It will be necessary to provide an implementation of the <code>KeyplePluginExtensionFactory</code> interface.
This factory is provided by the API of the used plugin.</p>
<p>Depending on the capabilities of the hardware, the plugin factory may or may not offer specific configuration options.
Please refer to the API of the plugin component you are considering to see what is appropriate for your application.</p>
<p>The registration provides in return an implementation of one of the <code>Plugin</code>, <code>ObservablePlugin</code> or <code>PoolPlugin</code> interfaces depending on the type of target plugin.</p>
<div class="alert alert-note">
<div>
A plugin is identified by a unique name in the system so that it can be retrieved at any time from the smart card service.
</div>
</div>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('8',this)">Copy</button></div>
<pre><code class=language-java id=code-8>// Here is for example the registration of the PC/SC plugin
Plugin plugin = smartCardService.registerPlugin(PcscPluginFactoryBuilder.builder().build());</code></pre>
<h3 id=configure-a-plugin>Configure a plugin</h3>
<p>Some plugin types may offer specific options.</p>
<p>Static options are usually directly exposed by the plugin factory API while dynamic options are exposed by the plugin extension API.</p>
<p>To access the plugin extension it is necessary to invoke the <code>getExtension(...)</code> method on the registered <code>Plugin</code> by specifying the expected class of the extension which must extends the <code>KeyplePluginExtension</code> interface.
After that, the dedicated methods are available from the resulting object.</p>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('9',this)">Copy</button></div>
<pre><code class=language-java id=code-9>// Here is a snippet showing the usage of the extension of the Stub plugin
plugin
    .getExtension(StubPlugin.class)
    .unplugReader(&#34;READER_1&#34;);</code></pre>
<h3 id=monitor-a-plugin>Monitor a plugin</h3>
<div class="alert alert-warning">
<div>
The plugin monitoring only applies to hardware environments in which the readers are removable.
Moreover, only plugins of type <code>ObservablePlugin</code> can be monitored.
</div>
</div>
<p>The observation of reader connections and disconnections is achieved
through a background task managed by Keyple Service.</p>
<p>To enable these observation mechanisms, it is imperative to provide:</p>
<ul>
<li>a plugin observer implementing the <code>PluginObserverSpi</code> interface to be notified of plugin events,</li>
<li>an exception handler implementing the <code>PluginObservationExceptionHandlerSpi</code> interface to be notified of errors that may occur during the monitoring or events notifications.</li>
</ul>
<p>These two interfaces are available in the <code>org.eclipse.keyple.core.service.spi</code> package of the Keyple Service component.</p>
<p>Here is an example of a plugin observer class including an exception handler:</p>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('11',this)">Copy</button></div>
<pre><code class=language-java id=code-11>class PluginObserver implements PluginObserverSpi, PluginObservationExceptionHandlerSpi {

    @Override
    public void onPluginEvent(PluginEvent event) {
        switch (event.getEventType()) {
            case READER_CONNECTED:
                // here the processing to be done when a reader is connected
                ...
                break;
            case READER_DISCONNECTED:
                // here the processing to be done when a reader is disconnected
                ...
                break;
            default:
                break;
        }
    }
    
    @Override
    public void onPluginObservationError(String pluginName, Throwable e) {
        // handle here the plugin exceptions raised while observing the readers
        ...
    }
}</code></pre>
<p>In order to access the dedicated setters, the plugin has to be cast to <code>ObservablePlugin</code>.</p>
<p>Since adding an observer will cause the Keyple Service to check for the presence of an exception handler,
the definition of the exception handler must be done first.</p>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('12',this)">Copy</button></div>
<pre><code class=language-java id=code-12>PluginObserver pluginObserver = new PluginObserver();
((ObservablePlugin) plugin).setPluginObservationExceptionHandler(pluginObserver);
((ObservablePlugin) plugin).addObserver(pluginObserver);</code></pre>
<div class="alert alert-note">
<div>
Note that the monitoring thread only works if there is at least one observer registered, and the notification process is sequential and synchronous.
</div>
</div>
<hr>
<h2 id=set-up-a-reader>Set up a reader</h2>
<p>The readers are provided by the plugins, that&rsquo;s why you have to <a href=#set-up-a-plugin>set up the plugin</a> first.</p>
<h3 id=access-to-a-reader>Access to a reader</h3>
<p>The hardware readers already connected are referenced in the system during the registration of the plugin.
For observable plugins, the references of the connected readers are updated in real time.</p>
<p>Readers are accessible directly from the associated <code>Plugin</code> instance.</p>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('14',this)">Copy</button></div>
<pre><code class=language-java id=code-14>// Here is an example to get the 1st available reader
String readerName = plugin.getReaderNames().get(0);
CardReader reader = plugin.getReader(readerName);</code></pre>
<div class="alert alert-note">
<div>
Depending on the type of plugin, the reader names are
more or less dynamic (e.g. a PC/SC based system vs. an embedded
terminal), it is sometimes necessary to implement an identification
mechanism in order to assign the right reader to the right place in the
system (for example by using regular expressions).
</div>
</div>
<h3 id=configure-a-reader>Configure a reader</h3>
<p>There are two types of configuration. Their availability depends on the characteristics of the reader:</p>
<ul>
<li>
<p>The reader is an instance of <code>ConfigurableCardReader</code>:<br>
It is then possible to activate or deactivate the protocols supported by the reader.</p>
<div class="alert alert-note"><div>Use of these methods may be optional if the application does not intend to target products by protocol filtering.</div></div>
</li>
<li>
<p>The reader&rsquo;s extension API exposes specific options:<br>
To access the reader extension it is necessary to invoke the <code>getReaderExtension(...)</code> method on the <code>Plugin</code> instance by specifying the expected class of the extension (which must extends the <code>KeypleReaderExtension</code> interface) and the reader&rsquo;s name.
After that, the dedicated methods, if any, are available from the resulting object.
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('16',this)">Copy</button></div>
<pre><code class=language-java id=code-16>// Here is a snippet showing how to get and use the extension of the Stub reader
plugin
    .getReaderExtension(StubReader.class, readerName)
    .removeCard();</code></pre></p>
</li>
</ul>
<h3 id=monitor-a-reader>Monitor a reader</h3>
<div class="alert alert-warning">
<div>
The reader monitoring only applies to hardware environments in which the smart cards are removable.
Moreover, only readers of type <code>ObservableCardReader</code> can be monitored.
</div>
</div>
<div class="alert alert-note">
<div>
Observation of the readers is optional in Keyple. It facilitates an event-driven programming mode, but an application
developer can choose not to observe a reader, either because this reader is not designed to manage card insertions/withdrawals (for example an
Android OMAPI reader or a SAM reader), or because the application is designed to directly manage the presence of a card (see to <code>isCardPresent</code> method of the
<code>CardReader</code> interface).
</div>
</div>
<p>The observation of card insertions and removals is achieved
through a background task managed by Keyple Service.</p>
<p>To enable these observation mechanisms, it is imperative to provide:</p>
<ul>
<li>a reader observer implementing the <code>CardReaderObserverSpi</code> interface to be notified of reader events,</li>
<li>an exception handler implementing the <code>CardReaderObservationExceptionHandlerSpi</code> interface to be notified of errors that may occur during the monitoring or events notifications.</li>
</ul>
<p>These two interfaces are available in the <code>org.calypsonet.terminal.reader.spi</code> package of the <strong>Calypsonet Terminal Reader API</strong> component.</p>
<p>Here is an example of a reader observer class including an exception handler:</p>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('19',this)">Copy</button></div>
<pre><code class=language-java id=code-19>class ReaderObserver implements CardReaderObserverSpi, CardReaderObservationExceptionHandlerSpi {

    @Override
    public void onReaderEvent(CardReaderEvent event) {
        switch (event.getType()) {
            case CardReaderEvent.Type.CARD_INSERTED:
                // here the processing to be done when a card is inserted
                ...
                break;
            case CardReaderEvent.Type.CARD_REMOVED:
                // here the processing to be done when a card is removed
                ...
                break;
            default:
                break;
        }
    }
    
    @Override
    public void onReaderObservationError(String pluginName, String readerName, Throwable e) {
        // handle here the reader exceptions raised while observing the cards
        ...
    }
}</code></pre>
<p>In order to access the dedicated setters, the reader has to be cast to <code>ObservableCardReader</code>.</p>
<p>Since adding an observer will cause the Keyple Service to check for the presence of an exception handler,
the definition of the exception handler must be done first.</p>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('20',this)">Copy</button></div>
<pre><code class=language-java id=code-20>ReaderObserver readerObserver = new ReaderObserver();
((ObservableCardReader) reader).setReaderObservationExceptionHandler(readerObserver);
((ObservableCardReader) reader).addObserver(readerObserver);
((ObservableCardReader) reader).startCardDetection(ObservableCardReader.DetectionMode.REPEATING);</code></pre>
<div class="alert alert-note">
<div>
Note that the <code>startCardDetection(...)</code> and <code>stopCardDetection()</code> methods start and stop the monitoring thread.
The API offers different options to manage the needs around card detection.<br>
Moreover, the notification process is sequential and synchronous.
</div>
</div>
<hr>
<h2 id=select-a-card>Select a card</h2>
<p>The starting point of any processing done with a card in the Keyple enrivonment, is to reference this card in the system.
It is the role of the selection step to obtain this reference.</p>
<p>You have first to prepare a selection scenario defining the eligible cards for a transaction, then to execute the scenario when a card is present.</p>
<h3 id=prepare-a-scenario>Prepare a scenario</h3>
<p>To prepare a scenario, you have to get a new instance of <code>CardSelectionManager</code> from the smart card service using the <code>createCardSelectionManager()</code> method,
then configure it with scenario cases using dedicated methods provided by one or more card extensions.</p>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('22',this)">Copy</button></div>
<pre><code class=language-java id=code-22>CardSelectionManager cardSelectionManager = smartCardService.createCardSelectionManager();```</code></pre>
<p>The <code>prepareSelection(...)</code> method allows to add a selection case to the scenario by providing an implementation of the <code>CardSelection</code> interface and return the index of the added case in order to be able to identify later the case that matched.</p>
<p>Please note that the order of addition is important because it will impact the selection cycle and favor the performance of the first added cases.</p>
<p>Providing one or more selection cases to the <code>CardSelectionManager</code> constitutes a selection scenario.
The scenario is run by Keyple Service when a card is detected, the different cases being evaluated
sequentially as long as the card does not match the criteria of the defined cases.</p>
<p>The selection process for a case offers several options for selecting a processing based on the type of card presented to the reader.</p>
<p>It is based on a filtering process according to three possible criteria,
each of which is optional:</p>
<ul>
<li>the communication protocol of the card (usually also identifying a
card technology)</li>
<li>the power-on data collected by the reader when the card is detected (e.g. the Answer To Reset)</li>
<li>the ISO standard application identifier (AID) used to perform a Select Application command.</li>
</ul>
<p>When a card is inserted, it is evaluated according to these criteria and
will be given the status &ldquo;selected&rdquo; or not.</p>
<p>When a card is not selected, no other operation will be possible with it.</p>
<p>The same card could correspond to several cases of the same scenario, especially when filtering by AID.
By default, the selection process will stop at the first case that matches.
It is however possible to choose another strategy using the <code>setMultipleSelectionMode()</code> method.
In this case, the process will continue to the last selection case in the scenario and return all results, but only the last matching application will be selected.</p>
<p>When a card is selected, the <code>CardSelectionManager</code> will make available the result
as a <code>SmartCard</code> object containing all the information known about the card at that stage.</p>
<p>Depending on the card extension that is used, this <code>SmartCard</code> object can be cast to a more
comprehensive object with specific features defined by the extension.</p>
<p>In addition to the selection process itself, specific APDU commands may be sent to the card if the selection is successful.
The output of these commands is available in the instance of the <code>SmartCard</code> object.</p>
<p>The following snippet shows the preparation of two selection cases using the generic card extension:
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('23',this)">Copy</button></div>
<pre><code class=language-java id=code-23>// prepare a selection for application 1
int firstCaseIndex = cardSelectionManager.prepareSelection(
    GenericExtensionService.getInstance()
        .createCardSelection()
        .filterByDfName(AID1));

// prepare a selection for application 2
int secondCaseIndex = cardSelectionManager.prepareSelection(
    GenericExtensionService.getInstance()
        .createCardSelection()
        .filterByDfName(AID2));</code></pre></p>
<h3 id=run-a-scenario>Run a scenario</h3>
<p>If we know that the card is in the reader it is possible to run a selection scenario by invoking the <code>processCardSelectionScenario(...)</code> method on the corresponding reader.
The result of the selection is then directly returned.</p>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('24',this)">Copy</button></div>
<pre><code class=language-java id=code-24>// Actual card communication: run the selection scenario.
CardSelectionResult selectionResult = cardSelectionManager.processCardSelectionScenario(reader);

// Get the SmartCard resulting of the selection.
SmartCard smartCard = selectionResult.getActiveSmartCard();

// Check the selection result.
if (smartCard == null) {
  throw new IllegalStateException(&#34;The selection of the card failed.&#34;);
}</code></pre>
<h3 id=schedule-a-scenario>Schedule a scenario</h3>
<p>If the reader is of type <code>ObservableCardReader</code> then it is possible to schedule in advance the execution of a selection scenario as soon as a card is presented.</p>
<p>Invoke the <code>scheduleCardSelectionScenario(...)</code> to register the previously prepared scenario in the observable reader.</p>
<p>In this case, it is necessary to register a reader observer and to have started the card detection in order to be able to retrieve the result of the selection which will be contained in a <code>CardReaderEvent</code>.</p>
<p>Use the <code>parseScheduledCardSelectionsResponse(...)</code> method to extract the selection result from the event.</p>
<p>Note that the scheduling of the execution of a scenario includes two options:</p>
<ul>
<li>the <code>DetectionMode</code> defining the expected behavior regarding the card detection allowing to automatically restart it or not.</li>
<li>the <code>NotificationMode</code> allowing to choose if only the cards matching the selection (successfully selected) should trigger an event.</li>
</ul>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('25',this)">Copy</button></div>
<pre><code class=language-java id=code-25>...
@Override
public void onReaderEvent(CardReaderEvent event) {
  try {
    switch (event.getType()) {
      case CardReaderEvent.Type.CARD_MATCHED:
        // Retrieve the selected smart card
        SmartCard smartCard =
            cardSelectionManager
                .parseScheduledCardSelectionsResponse(event.getScheduledCardSelectionsResponse())
                .getActiveSmartCard();
        // Perform the transaction
        ...
        break;
      default:
        break;
    }
  } finally {
    // Ensures that the communication channel is closed, regardless of the processing with the card.
    ((ObservableCardReader) (reader)).finalizeCardProcessing();
  }
}
...</code></pre>
<div class="alert alert-note">
<div>
<p>The <code>finalizeCardProcessing()</code> method must be invoked at the end of the transaction to ensure that the communication channel is closed.
This switches the underlying monitoring thread into a state of waiting for the card to be removed.</p>
<p>Not doing this can lead to blocking states of the card insertion/removal monitoring mechanism.</p>
</div>
</div>
<hr>
<h2 id=perform-a-transaction>Perform a transaction</h2>
<p>Once the smart card is referenced in the system it is possible to perform the desired transaction using the appropriate card extension.</p>
<p>When the transaction is completed, if the reader is observed, it is imperative to invoke the <code>finalizeCardProcessing()</code> method on the observable reader (see the above note).</p>
<hr>
<h2 id=unregister-a-plugin>Unregister a plugin</h2>
<p>To shut down a Keyple application properly, it is necessary to free the resources and in particular to close opened card physical channels and stop the observation threads.</p>
<p>This is done by unregistering the plugins in the following way:</p>
<div class=bd-clipboard><button type=button class="btn btn-clipboard btn-outline-light" title="Copy to clipboard" onclick="copyCodeContentToClipboard('27',this)">Copy</button></div>
<pre><code class=language-java id=code-27>smartCardService.unregisterPlugin(plugin.getName());</code></pre>
<hr>
<h2 id=api>API</h2>
<ul>
<li><a href=https://calypsonet.github.io/calypsonet-terminal-reader-java-api target=_blank rel=noopener>Calypsonet Terminal Reader API</a></li>
<li><a href=https://eclipse.github.io/keyple-common-java-api target=_blank rel=noopener>Keyple Common API</a></li>
<li><a href=https://eclipse.github.io/keyple-service-java-lib target=_blank rel=noopener>Keyple Service API</a></li>
</ul>
<hr>
<h2 id=examples>Examples</h2>
<ul>
<li><a href=https://github.com/eclipse/keyple-java-example target=_blank rel=noopener>Java examples</a></li>
</ul>
<hr>
<h2 id=download>Download</h2>
<ul>
<li><a href=https://keyple.org/components-java/overview/configuration-wizard/>Java components</a></li>
</ul>
</div>
<div class=article-widget>
<div class=post-nav>
<div class=post-nav-item>
<div class=meta-nav>Next</div>
<a href=../../../learn/user-guide/distributed-application/ rel=prev>Distributed Application User Guide</a>
</div>
</div>
</div>
</div>
<div class=body-footer>
<p>Last updated on 2022-07-26</p>
</div>
</article>
<footer class=site-footer>
<div class=container>
<div class="row featurette">
<div class="col-12 col-sm-4">
<p style=color:#fff><b>ECLIPSE LEGAL</b></p>
<a href=https://www.eclipse.org/legal/privacy.php>Privacy Policy</a><br>
<a href=https://www.eclipse.org/legal/termsofuse.php>Terms of Use</a><br>
<a href=https://www.eclipse.org/legal/copyright.php>Copyright Agent</a><br>
<a href=https://www.eclipse.org/legal/epl-2.0/>Eclipse Public License</a><br>
<a href=https://www.eclipse.org/legal/>Legal Resources</a><br>
<a href=https://eclipse.org/security/ target=_blank>Report a Vulnerability</a><br>
</div>
<div class="col-12 col-sm-4">
<a href=https://www.eclipse.org target=_blank>
<img src=../../../media/eclipse_foundation_logo.svg id=logo-eclipse-foundation>
</a>
</div>
<div class="col-12 col-sm-4">
<a href=https://iot.eclipse.org target=_blank>
<img src=../../../media/eclipse_iot_logo.svg id=logo-eclipse-iot>
</a>
</div>
</div>
</div>
<p class=powered-by id=copyright>
© 2020-2022 The Eclipse Keyple® project. All Rights Reserved.
</p>
<p class=powered-by id=template-info>
Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.
</p>
</footer>
</main>
</div>
</div>
</div>
<div class=page-footer>
</div>
<div id=modal class="modal fade" role=dialog>
<div class=modal-dialog>
<div class=modal-content>
<div class=modal-header>
<h5 class=modal-title>Cite</h5>
<button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span>
</button>
</div>
<div class=modal-body>
<pre><code class="tex hljs"></code></pre>
</div>
<div class=modal-footer>
<a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank>
<i class="fas fa-copy"></i> Copy
</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank>
<i class="fas fa-download"></i> Download
</a>
<div id=modal-error></div>
</div>
</div>
</div>
</div>
<script src=../../../js/vendor-bundle.min.b73dfaac3b6499dc997741748a7c3fe2.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/java.min.js crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/groovy.min.js crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/xml.min.js crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/kotlin.min.js crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/cpp.min.js crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/gradle.min.js crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/ini.min.js crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script>
<script>anchors.add()</script>
<script id=search-hit-fuse-template type=text/x-template>
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script>
<script src=../../../en/js/wowchemy.min.023c75ad1e0e5e4b65d451da95dc5d4b.js></script>
<link rel=stylesheet href=https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css>
<script src=https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js></script>
<script src=https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js></script>
</body>
</html>