<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3617px" preserveAspectRatio="none" style="width:1560px;height:3617px;" version="1.1" viewBox="0 0 1560 3617" width="1560px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="139.7578" style="stroke: #000000; stroke-width: 2.0;" width="282" x="13" y="524.5313"/><rect fill="#FFFFFF" height="200.4609" style="stroke: #000000; stroke-width: 2.0;" width="278.5" x="13" y="1486.4844"/><rect fill="#FFFFFF" height="172.4609" style="stroke: #000000; stroke-width: 2.0;" width="335.5" x="1203" y="2475.7891"/><rect fill="#FFFFFF" height="172.4609" style="stroke: #000000; stroke-width: 2.0;" width="335.5" x="1203" y="2662.25"/><rect fill="#FFFFFF" height="139.7578" style="stroke: #000000; stroke-width: 2.0;" width="278.5" x="13" y="3035.5234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="38" x2="38" y1="83.6094" y2="3605.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="238.5" x2="238.5" y1="83.6094" y2="3605.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="362" x2="362" y1="83.6094" y2="3605.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="864" x2="864" y1="83.6094" y2="3605.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1260" x2="1260" y1="83.6094" y2="3605.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1510.5" x2="1510.5" y1="83.6094" y2="3605.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="20" x="25" y="80.5332">PO</text><ellipse cx="38" cy="13" fill="#FEFECE" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M38,21 L38,48 M25,29 L51,29 M38,48 L25,63 M38,48 L51,63 " fill="none" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="196.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="203.5" y="72.5332">PO Reader</text><rect fill="#FEFECE" height="49.2188" style="stroke: #A80036; stroke-width: 1.5;" width="82" x="321" y="33.3906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="333.5" y="54.9238">Ticketing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="328" y="72.5332">application</text><rect fill="#FEFECE" height="49.2188" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="807" y="33.3906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="815" y="54.9238">Keyple Calypso</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="814" y="72.5332">Transaction API</text><rect fill="#FEFECE" height="31.6094" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="1213" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="1220" y="72.5332">SAM Reader</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="1493.5" y="80.5332">SAM</text><ellipse cx="1511" cy="13" fill="#FEFECE" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M1511,21 L1511,48 M1498,29 L1524,29 M1511,48 L1498,63 M1511,48 L1524,63 " fill="none" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#EEEEEE" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1545.5" x="3" y="114.7852"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1548.5" y1="114.7852" y2="114.7852"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1548.5" y1="117.7852" y2="117.7852"/><rect fill="#EEEEEE" height="24.3516" style="stroke: #000000; stroke-width: 2.0;" width="124" x="713.75" y="103.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="719.75" y="121.1045">PO Identification</text><polygon fill="#A80036" points="852,156.3125,862,160.3125,852,164.3125,856,160.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="160.3125" y2="160.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="369" y="155.4561">new PoSelectionRequest(new PoSelector(SpecificAid, InvalidatedPo.REJECT))</text><polygon fill="#A80036" points="852,186.6641,862,190.6641,852,194.6641,856,190.6641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="190.6641" y2="190.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="369" y="185.8076">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="423" y="185.8076">ReadRecord(SFI_Environment)</text><polygon fill="#A80036" points="852,217.0156,862,221.0156,852,225.0156,856,221.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="221.0156" y2="221.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="369" y="216.1592">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="423" y="216.1592">ReadRecord(SFI_ContractsList)</text><polygon fill="#A80036" points="852,247.3672,862,251.3672,852,255.3672,856,251.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="251.3672" y2="251.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="369" y="246.5107">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="423" y="246.5107">CardSelection</text><polygon fill="#A80036" points="852,277.7188,862,281.7188,852,285.7188,856,281.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="281.7188" y2="281.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48" x="369" y="276.8623">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="421" y="276.8623">ExplicitSelection(PO Reader)</text><polygon fill="#0000FF" points="250,324.4219,240,328.4219,250,332.4219,246,328.4219" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="244" x2="863" y1="328.4219" y2="328.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="256" y="307.2139">PO 1: transmits</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413" x="355" y="307.2139">SelectionRequest(PoSelector, ApduCommands[ReadRecord(SFI_Env)],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="256" y="323.5654">keep  PO Channel)</text><polygon fill="#A80036" points="49,354.7734,39,358.7734,49,362.7734,45,358.7734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="358.7734" y2="358.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="55" y="353.917">Open card channel</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="389.125" y2="385.125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="389.125" y2="393.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="389.125" y2="389.125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="45" y="384.2686">ack</text><polygon fill="#A80036" points="49,415.4766,39,419.4766,49,423.4766,45,419.4766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="419.4766" y2="419.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="55" y="414.6201">SelectApplication</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="449.8281" y2="445.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="449.8281" y2="453.8281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="449.8281" y2="449.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="45" y="444.9717">PO FCI</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="239" x2="281" y1="496.5313" y2="496.5313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="281" x2="281" y1="496.5313" y2="509.5313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="240" x2="281" y1="509.5313" y2="509.5313"/><polygon fill="#A80036" points="250,505.5313,240,509.5313,250,513.5313,246,509.5313" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="246" y="475.3232">checks invalidation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="246" y="491.6748">status</text><path d="M13,524.5313 L290,524.5313 L290,532.5313 L280,542.5313 L13,542.5313 L13,524.5313 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="139.7578" style="stroke: #000000; stroke-width: 2.0;" width="282" x="13" y="524.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="232" x="28" y="539.0264">PO APDU commands outside session</text><polygon fill="#A80036" points="49,561.2344,39,565.2344,49,569.2344,45,565.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="565.2344" y2="565.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="55" y="560.3779">ReadRecord(SFI_Env)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="595.5859" y2="591.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="595.5859" y2="599.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="595.5859" y2="595.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="45" y="590.7295">Env EF data</text><polygon fill="#A80036" points="49,621.9375,39,625.9375,49,629.9375,45,625.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="625.9375" y2="625.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="55" y="621.0811">ReadRecord(SFI_CList)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="656.2891" y2="652.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="656.2891" y2="660.2891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="656.2891" y2="656.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="45" y="651.4326">CList EF data</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="862" x2="852" y1="693.6406" y2="689.6406"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="862" x2="852" y1="693.6406" y2="697.6406"/><line style="stroke: #0000FF; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="239" x2="863" y1="693.6406" y2="693.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="246" y="688.7842">replies</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="445" x="293" y="688.7842">SelectionResponse(SelectionStatus(PO FCI), ApduResponses[Env EF data])</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="906" y1="740.3438" y2="740.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="906" x2="906" y1="740.3438" y2="753.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865" x2="906" y1="753.3438" y2="753.3438"/><polygon fill="#A80036" points="875,749.3438,865,753.3438,875,757.3438,871,753.3438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="871" y="719.1357">Calypso card identified</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="871" y="735.4873">(PO type, serial, revision, features)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="906" y1="800.0469" y2="800.0469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="906" x2="906" y1="800.0469" y2="813.0469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865" x2="906" y1="813.0469" y2="813.0469"/><polygon fill="#A80036" points="875,809.0469,865,813.0469,875,817.0469,871,813.0469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="871" y="778.8389">Card validity check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="871" y="795.1904">(black listed serial, HCE token expiration)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="843.3984" y2="839.3984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="843.3984" y2="847.3984"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="362" x2="863" y1="843.3984" y2="843.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="379" y="838.542">Calypso card image: PoCard</text><polygon fill="#A80036" points="852,869.75,862,873.75,852,877.75,856,873.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="873.75" y2="873.75"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="369" y="868.8936">PoCard.getEfFileData(SFI_Env)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="904.1016" y2="900.1016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="904.1016" y2="908.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="362" x2="863" y1="904.1016" y2="904.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="379" y="899.2451">Environment bytes</text><polygon fill="#A80036" points="852,930.4531,862,934.4531,852,938.4531,856,934.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="934.4531" y2="934.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="369" y="929.5967">PoCard.getEfFileData(SFI_CList)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="964.8047" y2="960.8047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="964.8047" y2="968.8047"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="362" x2="863" y1="964.8047" y2="964.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="379" y="959.9482">ContractsList bytes</text><rect fill="#EEEEEE" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1545.5" x="3" y="993.9805"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1548.5" y1="993.9805" y2="993.9805"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1548.5" y1="996.9805" y2="996.9805"/><rect fill="#EEEEEE" height="24.3516" style="stroke: #000000; stroke-width: 2.0;" width="139" x="706.25" y="982.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="712.25" y="1000.2998">PO Secure Session</text><polygon fill="#A80036" points="852,1051.8594,862,1055.8594,852,1059.8594,856,1055.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="1055.8594" y2="1055.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="369" y="1034.6514">new PoTransaction({PoReader, PoCard}, {SamReader, SamCard},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="369" y="1051.0029">SessionMode.ATOMIC)</text><polygon fill="#A80036" points="852,1082.2109,862,1086.2109,852,1090.2109,856,1086.2109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="1086.2109" y2="1086.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="369" y="1081.3545">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="423" y="1081.3545">ReadRecord(SFI_Environment)</text><polygon fill="#A80036" points="852,1112.5625,862,1116.5625,852,1120.5625,856,1116.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="1116.5625" y2="1116.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="369" y="1111.7061">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="423" y="1111.7061">ReadRecord(SFI_Contract1)</text><polygon fill="#A80036" points="852,1142.9141,862,1146.9141,852,1150.9141,856,1146.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="1146.9141" y2="1146.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="369" y="1142.0576">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="423" y="1142.0576">ReadCounter(SFI_Counter1)</text><polygon fill="#A80036" points="852,1173.2656,862,1177.2656,852,1181.2656,856,1177.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="1177.2656" y2="1177.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48" x="369" y="1172.4092">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="421" y="1172.4092">Opening(PO_DebitKey)</text><polygon fill="#00FF00" points="1248,1236.3203,1258,1240.3203,1248,1244.3203,1252,1240.3203" style="stroke: #00FF00; stroke-width: 1.0;"/><line style="stroke: #00FF00; stroke-width: 1.0;" x1="864" x2="1254" y1="1240.3203" y2="1240.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="871" y="1202.7607">SAM 1: transmits</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="980" y="1202.7607">CardRequest(ApduCommands[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="871" y="1219.1123">SelectDiversifier(PO_Serial), GetChallenge],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="871" y="1235.4639">keep  SAM Channel)</text><polygon fill="#A80036" points="1499,1266.6719,1509,1270.6719,1499,1274.6719,1503,1270.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1505" y1="1270.6719" y2="1270.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="1267" y="1265.8154">SelectDiversifier</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="1301.0234" y2="1297.0234"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="1301.0234" y2="1305.0234"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1260" x2="1510" y1="1301.0234" y2="1301.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1277" y="1296.167">ack</text><polygon fill="#A80036" points="1499,1327.375,1509,1331.375,1499,1335.375,1503,1331.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1505" y1="1331.375" y2="1331.375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="1267" y="1326.5186">GetChallenge</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="1361.7266" y2="1357.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="1361.7266" y2="1365.7266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1260" x2="1510" y1="1361.7266" y2="1361.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="1277" y="1356.8701">SAM challenge</text><line style="stroke: #00FF00; stroke-width: 1.0;" x1="864" x2="874" y1="1408.4297" y2="1404.4297"/><line style="stroke: #00FF00; stroke-width: 1.0;" x1="864" x2="874" y1="1408.4297" y2="1412.4297"/><line style="stroke: #00FF00; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="864" x2="1259" y1="1408.4297" y2="1408.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="881" y="1387.2217">replies</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="928" y="1387.2217">CardResponse(ApduResponses[ack,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="881" y="1403.5732">SAM challenge])</text><polygon fill="#0000FF" points="250,1467.4844,240,1471.4844,250,1475.4844,246,1471.4844" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="244" x2="863" y1="1471.4844" y2="1471.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="256" y="1433.9248">PO 2: transmits</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="355" y="1433.9248">CardRequest(ApduCommands[OpenSession(PO_DebitKey,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="532" x="256" y="1450.2764">SAM challenge,SFI_Env to read), ReadRecord(SFI_Contract1, ReadCounter(SFI_Counter1)],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="256" y="1466.6279">keep  SAM Channel)</text><path d="M13,1486.4844 L282,1486.4844 L282,1494.4844 L272,1504.4844 L13,1504.4844 L13,1486.4844 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="200.4609" style="stroke: #000000; stroke-width: 2.0;" width="278.5" x="13" y="1486.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="1500.9795">PO APDU commands inside session</text><polygon fill="#A80036" points="49,1523.1875,39,1527.1875,49,1531.1875,45,1527.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="1527.1875" y2="1527.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="55" y="1522.3311">OpenSession</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="1557.5391" y2="1553.5391"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="1557.5391" y2="1561.5391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="1557.5391" y2="1557.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="45" y="1552.6826">PO challenge, Env EF data</text><polygon fill="#A80036" points="49,1583.8906,39,1587.8906,49,1591.8906,45,1587.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="1587.8906" y2="1587.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="55" y="1583.0342">ReadRecord</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="1618.2422" y2="1614.2422"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="1618.2422" y2="1622.2422"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="1618.2422" y2="1618.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="45" y="1613.3857">Contract1 EF data</text><polygon fill="#A80036" points="49,1644.5938,39,1648.5938,49,1652.5938,45,1648.5938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="1648.5938" y2="1648.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="55" y="1643.7373">ReadCounter</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="1678.9453" y2="1674.9453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="1678.9453" y2="1682.9453"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="1678.9453" y2="1678.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="45" y="1674.0889">Counter1 EF data</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="862" x2="852" y1="1732.6484" y2="1728.6484"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="862" x2="852" y1="1732.6484" y2="1736.6484"/><line style="stroke: #0000FF; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="239" x2="863" y1="1732.6484" y2="1732.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="246" y="1711.4404">replies</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="293" y="1711.4404">CardResponse(ApduResponses[Open response with Env EF data,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="246" y="1727.792">Contracts1 EF data, Counter1 EF data])</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="906" y1="1779.3516" y2="1779.3516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="906" x2="906" y1="1779.3516" y2="1792.3516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865" x2="906" y1="1792.3516" y2="1792.3516"/><polygon fill="#A80036" points="875,1788.3516,865,1792.3516,875,1796.3516,871,1792.3516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="871" y="1758.1436">Card responses consistency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="871" y="1774.4951">(avoid injection command attack)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="906" y1="1839.0547" y2="1839.0547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="906" x2="906" y1="1839.0547" y2="1852.0547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865" x2="906" y1="1852.0547" y2="1852.0547"/><polygon fill="#A80036" points="875,1848.0547,865,1852.0547,875,1856.0547,871,1852.0547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="871" y="1817.8467">Card session commands</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="871" y="1834.1982">memorized in cache (SAM digest not updated)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="906" y1="1882.4063" y2="1882.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="906" x2="906" y1="1882.4063" y2="1895.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865" x2="906" y1="1895.4063" y2="1895.4063"/><polygon fill="#A80036" points="875,1891.4063,865,1895.4063,875,1899.4063,871,1895.4063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="871" y="1877.5498">Ratification status check</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="906" y1="1958.4609" y2="1958.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="906" x2="906" y1="1958.4609" y2="1971.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865" x2="906" y1="1971.4609" y2="1971.4609"/><polygon fill="#A80036" points="875,1967.4609,865,1971.4609,875,1975.4609,871,1971.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="871" y="1920.9014">Card image update</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="871" y="1937.2529">data consistency check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="871" y="1953.6045">(Env read outside &amp; inside session)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="2001.8125" y2="1997.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="2001.8125" y2="2005.8125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="362" x2="863" y1="2001.8125" y2="2001.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="379" y="1996.9561">ack</text><polygon fill="#A80036" points="852,2028.1641,862,2032.1641,852,2036.1641,856,2032.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="2032.1641" y2="2032.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="369" y="2027.3076">PoCard.getEfFileData(SFI_Contract1)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="2062.5156" y2="2058.5156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="2062.5156" y2="2066.5156"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="362" x2="863" y1="2062.5156" y2="2062.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="379" y="2057.6592">Contract1 bytes</text><polygon fill="#A80036" points="852,2088.8672,862,2092.8672,852,2096.8672,856,2092.8672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="2092.8672" y2="2092.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="369" y="2088.0107">PoCard.getEfFileData(SFI_Counter1)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="2123.2188" y2="2119.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="2123.2188" y2="2127.2188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="362" x2="863" y1="2123.2188" y2="2123.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="379" y="2118.3623">Counter1 value</text><polygon fill="#A80036" points="852,2149.5703,862,2153.5703,852,2157.5703,856,2153.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="2153.5703" y2="2153.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="369" y="2148.7139">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="423" y="2148.7139">UpdateRecord(SFI_Event, EventData)</text><polygon fill="#A80036" points="852,2179.9219,862,2183.9219,852,2187.9219,856,2183.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="2183.9219" y2="2183.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="369" y="2179.0654">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="423" y="2179.0654">DecreaseCounter(SFI_Counter1, ValueToDecrease)</text><polygon fill="#A80036" points="852,2210.2734,862,2214.2734,852,2218.2734,856,2214.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="2214.2734" y2="2214.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="369" y="2209.417">prepare</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="423" y="2209.417">releaseChannel()</text><polygon fill="#A80036" points="852,2240.625,862,2244.625,852,2248.625,856,2244.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="858" y1="2244.625" y2="2244.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48" x="369" y="2239.7686">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="421" y="2239.7686">Closing(Not Ratified)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="906" y1="2291.3281" y2="2291.3281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="906" x2="906" y1="2291.3281" y2="2304.3281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865" x2="906" y1="2304.3281" y2="2304.3281"/><polygon fill="#A80036" points="875,2300.3281,865,2304.3281,875,2308.3281,871,2304.3281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="871" y="2270.1201">Anticipation of the future card responses</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="871" y="2286.4717">update of the session cache</text><polygon fill="#00FF00" points="1248,2396.0859,1258,2400.0859,1248,2404.0859,1252,2400.0859" style="stroke: #00FF00; stroke-width: 1.0;"/><line style="stroke: #00FF00; stroke-width: 1.0;" x1="864" x2="1254" y1="2400.0859" y2="2400.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="871" y="2329.8232">SAM 2: transmits</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="980" y="2329.8232">CardRequest(ApduCommands[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="871" y="2346.1748">DigestInit(PO_OpenResponse), DigestUpdateMultiple</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="871" y="2362.5264">, DigestUpdateMultiple, DigestUpdateMultiple,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="871" y="2378.8779">DigestUpdateMultiple, DigestClose],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="871" y="2395.2295">keep  SAM Channel)</text><polygon fill="#A80036" points="1499,2426.4375,1509,2430.4375,1499,2434.4375,1503,2430.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1505" y1="2430.4375" y2="2430.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="1267" y="2425.5811">DigestInit</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2460.7891" y2="2456.7891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2460.7891" y2="2464.7891"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1260" x2="1510" y1="2460.7891" y2="2460.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1277" y="2455.9326">ack</text><path d="M1203,2475.7891 L1399,2475.7891 L1399,2483.7891 L1389,2493.7891 L1203,2493.7891 L1203,2475.7891 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="172.4609" style="stroke: #000000; stroke-width: 2.0;" width="335.5" x="1203" y="2475.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="1218" y="2490.2842">'n' session MAC updates</text><polygon fill="#A80036" points="1499,2528.8438,1509,2532.8438,1499,2536.8438,1503,2532.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1505" y1="2532.8438" y2="2532.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="1267" y="2511.6357">DigestUpdateMultiple(ReadRecord</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="1267" y="2527.9873">cmd &amp; responses)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2563.1953" y2="2559.1953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2563.1953" y2="2567.1953"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1260" x2="1510" y1="2563.1953" y2="2563.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1277" y="2558.3389">ack</text><polygon fill="#A80036" points="1499,2605.8984,1509,2609.8984,1499,2613.8984,1503,2609.8984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1505" y1="2609.8984" y2="2609.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="1267" y="2588.6904">DigestUpdateMplutiple(ReadRecord</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="1267" y="2605.042">cmd &amp; responses)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2640.25" y2="2636.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2640.25" y2="2644.25"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1260" x2="1510" y1="2640.25" y2="2640.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1277" y="2635.3936">ack</text><path d="M1203,2662.25 L1418,2662.25 L1418,2670.25 L1408,2680.25 L1203,2680.25 L1203,2662.25 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="172.4609" style="stroke: #000000; stroke-width: 2.0;" width="335.5" x="1203" y="2662.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="1218" y="2676.7451">'2 * z' session MAC updates</text><polygon fill="#A80036" points="1499,2715.3047,1509,2719.3047,1499,2723.3047,1503,2719.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1505" y1="2719.3047" y2="2719.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1267" y="2698.0967">DigestUpdateMultiple(UpdateRecord</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="1267" y="2714.4482">cmd &amp;</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="1309" y="2714.4482">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1384" y="2714.4482">response)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2749.6563" y2="2745.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2749.6563" y2="2753.6563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1260" x2="1510" y1="2749.6563" y2="2749.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1277" y="2744.7998">ack</text><polygon fill="#A80036" points="1499,2792.3594,1509,2796.3594,1499,2800.3594,1503,2796.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1505" y1="2796.3594" y2="2796.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="1267" y="2775.1514">DigestUpdateMultiple(DecreaseCounter</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="1267" y="2791.5029">cmd &amp;</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="1309" y="2791.5029">anticipated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1384" y="2791.5029">response)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2826.7109" y2="2822.7109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2826.7109" y2="2830.7109"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1260" x2="1510" y1="2826.7109" y2="2826.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1277" y="2821.8545">ack</text><polygon fill="#A80036" points="1499,2860.0625,1509,2864.0625,1499,2868.0625,1503,2864.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1505" y1="2864.0625" y2="2864.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="1267" y="2859.2061">DigestClose</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2894.4141" y2="2890.4141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="2894.4141" y2="2898.4141"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1260" x2="1510" y1="2894.4141" y2="2894.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="1277" y="2889.5576">SAM certificate</text><line style="stroke: #00FF00; stroke-width: 1.0;" x1="864" x2="874" y1="2957.4688" y2="2953.4688"/><line style="stroke: #00FF00; stroke-width: 1.0;" x1="864" x2="874" y1="2957.4688" y2="2961.4688"/><line style="stroke: #00FF00; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="864" x2="1259" y1="2957.4688" y2="2957.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="881" y="2919.9092">replies</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="928" y="2919.9092">CardResponse(ApduResponses[DigestInit status,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="881" y="2936.2607">DigestUpdateMultiple</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="6" x="1004" y="2936.2607">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="1014" y="2936.2607">status], DigestClose reponse</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="881" y="2952.6123">with SAM certificate)</text><polygon fill="#0000FF" points="250,3016.5234,240,3020.5234,250,3024.5234,246,3020.5234" style="stroke: #0000FF; stroke-width: 1.0;"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="244" x2="863" y1="3020.5234" y2="3020.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="256" y="2982.9639">PO 3: transmits</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="502" x="355" y="2982.9639">CardRequest(ApduCommands[UpdateRecord(SFI_Event), DecreaseCounter(decValue),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="256" y="2999.3154">CloseSession(SamCertificate),RatificationCommand],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="256" y="3015.667">keep  SAM Channel)</text><path d="M13,3035.5234 L282,3035.5234 L282,3043.5234 L272,3053.5234 L13,3053.5234 L13,3035.5234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="139.7578" style="stroke: #000000; stroke-width: 2.0;" width="278.5" x="13" y="3035.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="3050.0186">PO APDU commands inside session</text><polygon fill="#A80036" points="49,3072.2266,39,3076.2266,49,3080.2266,45,3076.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="3076.2266" y2="3076.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="55" y="3071.3701">UpdateRecord</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="3106.5781" y2="3102.5781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="3106.5781" y2="3110.5781"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="3106.5781" y2="3106.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="45" y="3101.7217">ack</text><polygon fill="#A80036" points="49,3132.9297,39,3136.9297,49,3140.9297,45,3136.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="3136.9297" y2="3136.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="55" y="3132.0732">DecreaseCounter</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="3167.2813" y2="3163.2813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="3167.2813" y2="3171.2813"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="3167.2813" y2="3167.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="45" y="3162.4248">new counter value</text><polygon fill="#A80036" points="49,3200.6328,39,3204.6328,49,3208.6328,45,3204.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="3204.6328" y2="3204.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="55" y="3199.7764">CloseSession(SAM certificate)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="3234.9844" y2="3230.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="3234.9844" y2="3238.9844"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="3234.9844" y2="3234.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="45" y="3230.1279">PO certificate</text><polygon fill="#A80036" points="49,3261.3359,39,3265.3359,49,3269.3359,45,3265.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="3265.3359" y2="3265.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="55" y="3260.4795">Ratification</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="3295.6875" y2="3291.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="3295.6875" y2="3299.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="3295.6875" y2="3295.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="45" y="3290.8311">ack</text><polygon fill="#A80036" points="49,3322.0391,39,3326.0391,49,3330.0391,45,3326.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="43" x2="238" y1="3326.0391" y2="3326.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="55" y="3321.1826">Close card channel</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="3356.3906" y2="3352.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237" x2="227" y1="3356.3906" y2="3360.3906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="38" x2="238" y1="3356.3906" y2="3356.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="45" y="3351.5342">ack</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="862" x2="852" y1="3403.0938" y2="3399.0938"/><line style="stroke: #0000FF; stroke-width: 1.0;" x1="862" x2="852" y1="3403.0938" y2="3407.0938"/><line style="stroke: #0000FF; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="239" x2="863" y1="3403.0938" y2="3403.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="246" y="3381.8857">replies</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="293" y="3381.8857">CardResponse(ApduResponses[UpdateReoord status,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="441" x="246" y="3398.2373">new Counter1 value, PO certificate, Ratification ack], ChannelStatus.Closed)</text><polygon fill="#00FF00" points="1248,3462.1484,1258,3466.1484,1248,3470.1484,1252,3466.1484" style="stroke: #00FF00; stroke-width: 1.0;"/><line style="stroke: #00FF00; stroke-width: 1.0;" x1="864" x2="1254" y1="3466.1484" y2="3466.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="871" y="3428.5889">SAM 3: transmits</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="980" y="3428.5889">CardRequest(ApduCommands[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="871" y="3444.9404">External Authenticate(PO certificate)],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="871" y="3461.292">keep  SAM Channel)</text><polygon fill="#A80036" points="1499,3492.5,1509,3496.5,1499,3500.5,1503,3496.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1505" y1="3496.5" y2="3496.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="1267" y="3491.6436">ExternalAuthenticate</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="3526.8516" y2="3522.8516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1260" x2="1270" y1="3526.8516" y2="3530.8516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1260" x2="1510" y1="3526.8516" y2="3526.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="1277" y="3521.9951">authentication status</text><line style="stroke: #00FF00; stroke-width: 1.0;" x1="864" x2="874" y1="3557.2031" y2="3553.2031"/><line style="stroke: #00FF00; stroke-width: 1.0;" x1="864" x2="874" y1="3557.2031" y2="3561.2031"/><line style="stroke: #00FF00; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="864" x2="1259" y1="3557.2031" y2="3557.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="881" y="3552.3467">replies</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="928" y="3552.3467">CardResponse(ApduResponses[Authentification status])</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="3587.5547" y2="3583.5547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="362" x2="372" y1="3587.5547" y2="3591.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="362" x2="863" y1="3587.5547" y2="3587.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="379" y="3582.6982">ack</text><!--MD5=[0a1993b5a059ad4df264bceb8f806184]
@startuml
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype
hide footbox

actor PO
participant "PO Reader" as POR
participant "Ticketing\napplication" as TA
participant "Keyple Calypso\nTransaction API" as KC
participant "SAM Reader" as SMR
actor SAM as SM

== PO Identification ==
TA->KC: new PoSelectionRequest(new PoSelector(SpecificAid, InvalidatedPo.REJECT))
TA->KC: **prepare** ReadRecord(SFI_Environment)
TA->KC: **prepare** ReadRecord(SFI_ContractsList)
TA->KC: **prepare** CardSelection
TA->KC: **process** ExplicitSelection(PO Reader)
POR<[#0000FF]-KC: **PO 1: transmits** SelectionRequest(PoSelector, ApduCommands[ReadRecord(SFI_Env)],\nkeep  PO Channel)

PO<-POR: Open card channel
PO- ->>POR: ack
PO<-POR: SelectApplication
PO- ->>POR: PO FCI
POR->POR: checks invalidation\nstatus
group PO APDU commands outside session
PO<-POR: ReadRecord(SFI_Env)
PO- ->>POR: Env EF data
PO<-POR: ReadRecord(SFI_CList)
PO- ->>POR: CList EF data
end
POR- -[#0000FF]>>KC: **replies** SelectionResponse(SelectionStatus(PO FCI), ApduResponses[Env EF data])
KC->KC: Calypso card identified\n(PO type, serial, revision, features)
KC->KC: Card validity check\n(black listed serial, HCE token expiration)
TA<<- -KC: Calypso card image: PoCard
TA->KC: PoCard.getEfFileData(SFI_Env)
TA<<- -KC: Environment bytes
TA->KC: PoCard.getEfFileData(SFI_CList)
TA<<- -KC: ContractsList bytes

== PO Secure Session ==
TA->KC: new PoTransaction({PoReader, PoCard}, {SamReader, SamCard},\nSessionMode.ATOMIC)
TA->KC: **prepare** ReadRecord(SFI_Environment)
TA->KC: **prepare** ReadRecord(SFI_Contract1)
TA->KC: **prepare** ReadCounter(SFI_Counter1)
TA->KC: **process** Opening(PO_DebitKey)

KC-[#00FF00]>SMR: **SAM 1: transmits** CardRequest(ApduCommands[\nSelectDiversifier(PO_Serial), GetChallenge],\nkeep  SAM Channel)
SMR->SM: SelectDiversifier
SMR<<- -SM: ack
SMR->SM: GetChallenge
SMR<<- -SM: SAM challenge
KC<<[#00FF00]- -SMR: **replies** CardResponse(ApduResponses[ack,\nSAM challenge])

POR<[#0000FF]-KC: **PO 2: transmits** CardRequest(ApduCommands[OpenSession(PO_DebitKey,\nSAM challenge,SFI_Env to read), ReadRecord(SFI_Contract1, ReadCounter(SFI_Counter1)],\nkeep  SAM Channel)
group PO APDU commands inside session
PO<-POR: OpenSession
PO- ->>POR: PO challenge, Env EF data
PO<-POR: ReadRecord
PO- ->>POR: Contract1 EF data
PO<-POR: ReadCounter
PO- ->>POR: Counter1 EF data
end
POR- -[#0000FF]>>KC: **replies** CardResponse(ApduResponses[Open response with Env EF data,\nContracts1 EF data, Counter1 EF data])
KC->KC: Card responses consistency\n(avoid injection command attack)
KC->KC: Card session commands\nmemorized in cache (SAM digest not updated)
KC->KC: Ratification status check
KC->KC: Card image update\ndata consistency check\n(Env read outside & inside session)
TA<<- -KC: ack
TA->KC: PoCard.getEfFileData(SFI_Contract1)
TA<<- -KC: Contract1 bytes
TA->KC: PoCard.getEfFileData(SFI_Counter1)
TA<<- -KC: Counter1 value

TA->KC: **prepare** UpdateRecord(SFI_Event, EventData)
TA->KC: **prepare** DecreaseCounter(SFI_Counter1, ValueToDecrease)
TA->KC: **prepare** releaseChannel()
TA->KC: **process** Closing(Not Ratified)

KC->KC: Anticipation of the future card responses\nupdate of the session cache

KC-[#00FF00]>SMR: **SAM 2: transmits** CardRequest(ApduCommands[\nDigestInit(PO_OpenResponse), DigestUpdateMultiple\n, DigestUpdateMultiple, DigestUpdateMultiple,\nDigestUpdateMultiple, DigestClose],\nkeep  SAM Channel)
SMR->SM: DigestInit
SMR<<- -SM:ack
group 'n' session MAC updates
SMR->SM: DigestUpdateMultiple(ReadRecord\ncmd & responses)
SMR<<- -SM: ack
SMR->SM: DigestUpdateMplutiple(ReadRecord\ncmd & responses)
SMR<<- -SM: ack
end
group '2 * z' session MAC updates
SMR->SM: DigestUpdateMultiple(UpdateRecord\ncmd & **anticipated** response)
SMR<<- -SM: ack
SMR->SM: DigestUpdateMultiple(DecreaseCounter\ncmd & **anticipated** response)
SMR<<- -SM: ack
end
SMR->SM: DigestClose
SMR<<- -SM: SAM certificate
KC<<[#00FF00]- -SMR: **replies** CardResponse(ApduResponses[DigestInit status,\nDigestUpdateMultiple**s** status], DigestClose reponse\nwith SAM certificate)

POR<[#0000FF]-KC: **PO 3: transmits** CardRequest(ApduCommands[UpdateRecord(SFI_Event), DecreaseCounter(decValue),\nCloseSession(SamCertificate),RatificationCommand],\nkeep  SAM Channel)
group PO APDU commands inside session
PO<-POR: UpdateRecord
PO- ->>POR: ack
PO<-POR: DecreaseCounter
PO- ->>POR: new counter value
end
PO<-POR: CloseSession(SAM certificate)
PO- ->>POR: PO certificate
PO<-POR: Ratification
PO- ->>POR: ack
PO<-POR: Close card channel
PO- ->>POR: ack
POR- -[#0000FF]>>KC: **replies** CardResponse(ApduResponses[UpdateReoord status,\nnew Counter1 value, PO certificate, Ratification ack], ChannelStatus.Closed)

KC-[#00FF00]>SMR: **SAM 3: transmits** CardRequest(ApduCommands[\nExternal Authenticate(PO certificate)],\nkeep  SAM Channel)
SMR->SM: ExternalAuthenticate
SMR<<- -SM: authentication status
KC<<[#00FF00]- -SMR: **replies** CardResponse(ApduResponses[Authentification status])


TA<<- -KC: ack
@enduml

PlantUML version 1.2020.09(Sun May 10 14:51:06 MUT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.7+10-b765.64
Operating System: Windows 10
Default Encoding: Cp1252
Language: fr
Country: FR
--></g></svg>