[
  {
    "url": "https://api.github.com/repos/eclipse-keyple/keyple-service-java-lib/issues/71",
    "repository_url": "https://api.github.com/repos/eclipse-keyple/keyple-service-java-lib",
    "labels_url": "https://api.github.com/repos/eclipse-keyple/keyple-service-java-lib/issues/71/labels{/name}",
    "comments_url": "https://api.github.com/repos/eclipse-keyple/keyple-service-java-lib/issues/71/comments",
    "events_url": "https://api.github.com/repos/eclipse-keyple/keyple-service-java-lib/issues/71/events",
    "html_url": "https://github.com/eclipse-keyple/keyple-service-java-lib/issues/71",
    "id": 2390924254,
    "node_id": "I_kwDODMWeus6Ogpve",
    "number": 71,
    "title": "Active card removal monitoring issue when stopped",
    "user": {
      "login": "amessara-billettiqueservices",
      "id": 106753080,
      "node_id": "U_kgDOBlzsOA",
      "avatar_url": "https://private-avatars.githubusercontent.com/u/106753080?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTEiLCJleHAiOjE3MzQ2NjQ4NjAsIm5iZiI6MTczNDY2MzY2MCwicGF0aCI6Ii91LzEwNjc1MzA4MCJ9.4IJ54JtSIbOc9Z8j1vd0jI1YdmOm8HsJA8AumQn0JAc&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amessara-billettiqueservices",
      "html_url": "https://github.com/amessara-billettiqueservices",
      "followers_url": "https://api.github.com/users/amessara-billettiqueservices/followers",
      "following_url": "https://api.github.com/users/amessara-billettiqueservices/following{/other_user}",
      "gists_url": "https://api.github.com/users/amessara-billettiqueservices/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amessara-billettiqueservices/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amessara-billettiqueservices/subscriptions",
      "organizations_url": "https://api.github.com/users/amessara-billettiqueservices/orgs",
      "repos_url": "https://api.github.com/users/amessara-billettiqueservices/repos",
      "events_url": "https://api.github.com/users/amessara-billettiqueservices/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amessara-billettiqueservices/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "labels": [

    ],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [

    ],
    "milestone": null,
    "comments": 2,
    "created_at": "2024-07-04T13:48:22Z",
    "updated_at": "2024-07-05T14:24:08Z",
    "closed_at": null,
    "author_association": "NONE",
    "active_lock_reason": null,
    "body": "Hello team,\r\n\r\nWe have a specific use case, in which, when a type of card is detected we stop everything and let another application handle the card.\r\n\r\nThis revealed an issue in Keyple as we still keep interacting with the reader after a `stopCardDetection()` has been called.\r\n\r\n`finalizeCardProcessing()` is called, switching the statemachine to `WAIT_FOR_CARD_REMOVAL` and starting an active card presence monitoring.\r\n```\r\n03-07-24 18:28:34.317 \t 1 \t DEBUG \t SmartcardNfcReader \t Finishing handling the card\r\n03-07-24 18:28:34.317 \t 1 \t DEBUG \t org.eclipse.keyple.core.service.ObservableLocalReaderAdapter \t Reader 'BluebirdReader' of plugin 'BluebirdPlugin' starts the removal sequence of the card.\r\n03-07-24 18:28:34.317 \t 1 \t VERBOSE \t org.eclipse.keyple.core.service.WaitForCardProcessingStateAdapter \t [BluebirdReader] onInternalEvent => Event CARD_PROCESSED received in currentState WAIT_FOR_CARD_PROCESSING\r\n03-07-24 18:28:34.318 \t 1 \t VERBOSE \t org.eclipse.keyple.core.service.ObservableReaderStateServiceAdapter \t [BluebirdReader] Switch currentState from WAIT_FOR_CARD_PROCESSING to WAIT_FOR_CARD_REMOVAL\r\n03-07-24 18:28:34.318 \t 1 \t VERBOSE \t org.eclipse.keyple.core.service.AbstractObservableStateAdapter \t [BluebirdReader] onDeactivate => WAIT_FOR_CARD_PROCESSING\r\n03-07-24 18:28:34.319 \t 1 \t VERBOSE \t org.eclipse.keyple.core.service.AbstractObservableStateAdapter \t [BluebirdReader] onActivate => WAIT_FOR_CARD_REMOVAL\r\n```\r\n\r\n`stopCardDetection()` is called to stop all operations on the card and reader and let the other application work\r\n\r\n```\r\n03-07-24 18:28:34.320 \t 1 \t DEBUG \t SmartcardNfcReader \t stopCardDetection()\r\n03-07-24 18:28:34.321 \t 1280 \t DEBUG \t org.eclipse.keyple.core.service.CardRemovalActiveMonitoringJobAdapter \t [BluebirdReader] Polling from isCardPresentPing\r\n03-07-24 18:28:34.321 \t 1 \t DEBUG \t org.eclipse.keyple.core.service.ObservableLocalReaderAdapter \t Reader 'BluebirdReader' of plugin 'BluebirdPlugin' stops the card detection.\r\n03-07-24 18:28:34.322 \t 1280 \t VERBOSE \t org.eclipse.keyple.core.service.ObservableLocalReaderAdapter \t [BluebirdReader] Ping card\r\n03-07-24 18:28:34.322 \t 1 \t DEBUG \t BluebirdReaderAdapter \t onStopDetection()\r\n03-07-24 18:28:34.322 \t 1280 \t DEBUG \t BluebirdReaderAdapter \t transmitApdu() apduIn=00C0000000\r\n03-07-24 18:28:34.324 \t 1 \t DEBUG \t BluebirdReaderAdapter \t extNfcReader.stopScan = 0\r\n03-07-24 18:28:34.326 \t 1 \t VERBOSE \t org.eclipse.keyple.core.service.WaitForCardRemovalStateAdapter \t [BluebirdReader] onInternalEvent => Event STOP_DETECT received in currentState WAIT_FOR_CARD_REMOVAL\r\n03-07-24 18:28:34.327 \t 1 \t VERBOSE \t org.eclipse.keyple.core.service.LocalReaderAdapter \t [BluebirdReader] closeLogicalChannel => Closing of the logical channel.\r\n03-07-24 18:28:34.327 \t 1 \t DEBUG \t BluebirdReaderAdapter \t closePhysicalChannel()\r\n03-07-24 18:28:34.327 \t 1 \t DEBUG \t org.eclipse.keyple.core.service.ObservableLocalReaderAdapter \t Reader 'BluebirdReader' notifies the reader event 'CARD_REMOVED' to 1 observer(s).\r\n```\r\n\r\nWe see at the same time the state machine being \"stopped\" (`WAIT_FOR_START_DETECTION`) and the removal monitoring job requested to stop. (It's a simple request and not an interruption. Ongoing jobs are allowed to finish)\r\n```\r\n03-07-24 18:28:34.379 \t 1280 \t DEBUG \t BluebirdReaderAdapter \t transmitApdu() result=6D00\r\n03-07-24 18:28:34.381 \t 1280 \t VERBOSE \t org.eclipse.keyple.core.service.CardRemovalActiveMonitoringJobAdapter \t [BluebirdReader] Polling retries : 1\r\n03-07-24 18:28:34.556 \t 1 \t DEBUG \t PeripheralObserver \t onChange(true,null\r\n03-07-24 18:28:34.557 \t 1 \t VERBOSE \t org.eclipse.keyple.core.service.ObservableReaderStateServiceAdapter \t [BluebirdReader] Switch currentState from WAIT_FOR_CARD_REMOVAL to WAIT_FOR_START_DETECTION\r\n03-07-24 18:28:34.557 \t 1 \t VERBOSE \t org.eclipse.keyple.core.service.AbstractObservableStateAdapter \t [BluebirdReader] onDeactivate => WAIT_FOR_CARD_REMOVAL\r\n03-07-24 18:28:34.557 \t 1 \t DEBUG \t org.eclipse.keyple.core.service.CardRemovalActiveMonitoringJobAdapter \t [BluebirdReader] Stop Polling \r\n03-07-24 18:28:34.558 \t 1 \t VERBOSE \t org.eclipse.keyple.core.service.AbstractObservableStateAdapter \t [BluebirdReader] onDeactivate => cancel monitoring job CardRemovalActiveMonitoringJobAdapter by thread interruption true\r\n03-07-24 18:28:34.558 \t 1 \t VERBOSE \t org.eclipse.keyple.core.service.AbstractObservableStateAdapter \t [BluebirdReader] onActivate => WAIT_FOR_START_DETECTION\r\n03-07-24 18:28:34.558 \t 1 \t DEBUG \t SmartcardNfcReader \t remove observer\r\n03-07-24 18:28:34.558 \t 1 \t DEBUG \t org.eclipse.keyple.core.service.ObservationManagerAdapter \t Reader 'BluebirdReader' of plugin 'BluebirdPlugin' is removing the observer 'BluebirdNfcReader'.\r\n```\r\n\r\n200ms later the card removal monitoring job awakens from a `Thread.sleep`, understands that a stop has been requested **BUT** tries to close the physical channel and send a `CARD_REMOVED` event.\r\n```\r\n03-07-24 18:28:34.582 \t 1280 \t DEBUG \t org.eclipse.keyple.core.service.CardRemovalActiveMonitoringJobAdapter \t [BluebirdReader] Polling loop has been stopped\r\n03-07-24 18:28:34.583 \t 1280 \t VERBOSE \t org.eclipse.keyple.core.service.WaitForCardRemovalStateAdapter \t [BluebirdReader] onInternalEvent => Event CARD_REMOVED received in currentState WAIT_FOR_CARD_REMOVAL\r\n03-07-24 18:28:34.583 \t 1280 \t VERBOSE \t org.eclipse.keyple.core.service.LocalReaderAdapter \t [BluebirdReader] closeLogicalChannel => Closing of the logical channel.\r\n03-07-24 18:28:34.583 \t 1280 \t DEBUG \t BluebirdReaderAdapter \t closePhysicalChannel()\r\n03-07-24 18:28:34.585 \t 1280 \t DEBUG \t org.eclipse.keyple.core.service.ObservableLocalReaderAdapter \t Reader 'BluebirdReader' notifies the reader event 'CARD_REMOVED' to 0 observer(s).\r\n03-07-24 18:28:34.591 \t 1280 \t VERBOSE \t org.eclipse.keyple.core.service.ObservableReaderStateServiceAdapter \t [BluebirdReader] Switch currentState from WAIT_FOR_START_DETECTION to WAIT_FOR_CARD_INSERTION\r\n03-07-24 18:28:34.591 \t 1280 \t VERBOSE \t org.eclipse.keyple.core.service.AbstractObservableStateAdapter \t [BluebirdReader] onDeactivate => WAIT_FOR_START_DETECTION\r\n03-07-24 18:28:34.592 \t 1280 \t VERBOSE \t org.eclipse.keyple.core.service.AbstractObservableStateAdapter \t [BluebirdReader] onActivate => WAIT_FOR_CARD_INSERTION\r\n```\r\n\r\nThis behavior is very problematic as we have already stopped everything and the reader is currently used by another application.\r\n\r\nI believe that the issue is in this `finally` block and simply checking if the loop has been stopped before should fix it.\r\nhttps://github.com/eclipse-keyple/keyple-service-java-lib/blob/df389b7fadba14c22fa63d86f358285b8869de50/src/main/java/org/eclipse/keyple/core/service/CardRemovalActiveMonitoringJobAdapter.java#L115-L117\r\n\r\n```Java\r\n} finally {\r\n          if(!loop.get()) {\r\n            monitoringState.onEvent(ObservableLocalReaderAdapter.InternalEvent.CARD_REMOVED);\r\n          }\r\n}\r\n```",
    "closed_by": null,
    "reactions": {
      "url": "https://api.github.com/repos/eclipse-keyple/keyple-service-java-lib/issues/71/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/eclipse-keyple/keyple-service-java-lib/issues/71/timeline",
    "performed_via_github_app": null,
    "state_reason": null
  }
]
