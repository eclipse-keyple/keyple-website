<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo Blox Builder 5.9.6"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" media=print onload='this.media="all"'><link rel=stylesheet href=../../../../css/vendor-bundle.min.047268c6dd09ad74ba54a0ba71837064.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.css integrity crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=../../../../css/wowchemy.2f9263fc44a928b033d7ab8a9897bd56.css><link rel=stylesheet href=../../../../css/libs/chroma/github-dark.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=../../../../css/libs/chroma/github-dark.min.css title=hl-dark media=print onload='this.media="all"' disabled><meta name=robots content="noindex"><meta name=description content="This quick start describes how to create a ready-to-execute C++ command-line application that runs a simple transaction based on a Calypso portable object involving two smart card readers."><link rel=alternate hreflang=en-us href=https://keyple.org/archives/docs-1.0/build-your-first-app/cpp-app/><link rel=canonical href=https://keyple.org/archives/docs-1.0/build-your-first-app/cpp-app/><link rel=manifest href=../../../../manifest.webmanifest><link rel=icon type=image/png href=../../../../media/icon_hu16db34b3636b127457de39ca2fab620f_9845_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=../../../../media/icon_hu16db34b3636b127457de39ca2fab620f_9845_180x180_fill_lanczos_center_3.png><meta name=theme-color content="#1D87BB"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://keyple.org/media/logo.svg"><meta property="og:type" content="article"><meta property="og:site_name" content="Eclipse Keyple"><meta property="og:url" content="https://keyple.org/archives/docs-1.0/build-your-first-app/cpp-app/"><meta property="og:title" content="Build your first C++ application | Eclipse Keyple"><meta property="og:description" content="This quick start describes how to create a ready-to-execute C++ command-line application that runs a simple transaction based on a Calypso portable object involving two smart card readers."><meta property="og:image" content="https://keyple.org/media/logo.svg"><meta property="og:locale" content="en-us"><meta property="article:modified_time" content="2024-05-03T09:28:52+02:00"><title>Build your first C++ application | Eclipse Keyple</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=e206a6caaa838d54976dc4630c539743><script src=../../../../js/wowchemy-init.min.d66af272089c6c0601f1a57edc3bf6ab.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class="page-header header--fixed"><header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=../../../../><img src=../../../../media/logo.svg alt="Eclipse Keyple"></a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=../../../../><img src=../../../../media/logo.svg alt="Eclipse Keyple"></a></div><div class="navbar-collapse main-menu-item collapse justify-content-center" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>What is Eclipse Keyple速</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=../../../../what-is-keyple/overview/><span>Overview</span></a>
<a class=dropdown-item href=../../../../what-is-keyple/why-trust/><span>Why trust Eclipse Keyple速?</span></a>
<a class=dropdown-item href=../../../../what-is-keyple/who-is-it-for/><span>Who is it for?</span></a>
<a class=dropdown-item href=../../../../#adopters><span>Who is using Eclipse Keyple速?</span></a>
<a class=dropdown-item href=../../../../what-is-keyple/what-is-calypso/><span>What is Calypso速?</span></a>
<a class=dropdown-item href=../../../../what-is-keyple/main-features/><span>Keyple's main features</span></a>
<a class=dropdown-item href=../../../../#news><span>News</span></a></div></li><li class=nav-item><a class=nav-link href=../../../../learn/overview><span>Learn</span></a></li><li class=nav-item><a class=nav-link href=../../../../components/overview><span>Components</span></a></li><li class="nav-item dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><span>Community</span><span class=caret></span></a><div class=dropdown-menu><a class=dropdown-item href=../../../../adopters-and-testimonials/><span>Adopters & Testimonials</span></a>
<a class=dropdown-item href=../../../../community/contributing/><span>Contributing</span></a>
<a class=dropdown-item href=../../../../community/roadmap/><span>Roadmap</span></a>
<a class=dropdown-item href=../../../../community/changelog/><span>Changelog</span></a>
<a class=dropdown-item href=../../../../project-dashboard/><span>Project dashboard</span></a>
<a class=dropdown-item href=../../../../statistics/><span>Statistics</span></a>
<a class=dropdown-item href="https://sonarcloud.io/organizations/eclipse/projects?search=keyple&amp;sort=-analysis_date"><span>Code quality dashboard</span></a>
<a class=dropdown-item href=https://projects.eclipse.org/projects/iot.keyple/><span>Eclipse Foundation Keyple page</span></a>
<a class=dropdown-item href=https://accounts.eclipse.org/mailing-list/keyple-dev/><span>Mailing list</span></a>
<a class=dropdown-item href=https://github.com/eclipse-keyple/keyple/><span>GitHub home repository</span></a></div></li><li class=nav-item><a class=nav-link href=../../../../external-resources/><span>External resources</span></a></li><li class=nav-item><a class=nav-link href=../../../../learn/build-your-first-app/><button class='btn btn-info'><i class='fas fa-rocket pr-1' aria-hidden=true></i> <span>START CODING</span></button></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav></header></div><div class=page-body><div class="container-fluid docs"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 docs-sidebar"><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">Build your first app
</span><span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>Search...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li><a href=../../../../archives/></a></li><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/docs-1.0/>== Docs 1.x ==</a><ul class="nav docs-sidenav"><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/docs-1.0/build-your-first-app/>Build your first app</a><ul class="nav docs-sidenav"><li><a href=../../../../archives/docs-1.0/build-your-first-app/java-app/>Java</a></li><li><a href=../../../../archives/docs-1.0/build-your-first-app/android-app/>Android</a></li><li class=active><a href=../../../../archives/docs-1.0/build-your-first-app/cpp-app/>C++</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/docs-1.0/developer-guide/>Developer guides</a><ul class="nav docs-sidenav"><li><a href=../../../../archives/docs-1.0/developer-guide/common-concepts/>Common concepts</a></li><li><a href=../../../../archives/docs-1.0/developer-guide/standalone-application/>Standalone application</a></li><li><a href=../../../../archives/docs-1.0/developer-guide/distributed-application/>Distributed application</a></li><li><a href=../../../../archives/docs-1.0/developer-guide/calypso-application/>Calypso application</a></li><li><a href=../../../../archives/docs-1.0/developer-guide/create-plugin/>Create a plugin</a></li><li><a href=../../../../archives/docs-1.0/developer-guide/create-extension/>Create an extension</a></li><li><a href=../../../../archives/docs-1.0/developer-guide/upgrade/>Upgrade Keyple</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/docs-1.0/api-reference/>API reference</a><ul class="nav docs-sidenav"><li><a href=../../../../archives/docs-1.0/api-reference/java-api/>Java</a></li><li><a href=../../../../archives/docs-1.0/api-reference/cpp-api/>C++</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/docs-1.0/architecture/>Architecture</a><ul class="nav docs-sidenav"><li><a href=../../../../archives/docs-1.0/architecture/keyple-global/>Global Solution</a></li><li><a href=../../../../archives/docs-1.0/architecture/keyple-core/>Keyple Core</a></li><li><a href=../../../../archives/docs-1.0/architecture/keyple-calypso/>Keyple Calypso</a></li></ul></div></ul></div><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/components-java-1.0/>== Java 1.x components ==</a><ul class="nav docs-sidenav"><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/components-java-1.0/core/>Core</a></div><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/components-java-1.0/distributed-systems/>Distributed systems</a><ul class="nav docs-sidenav"><li><a href=../../../../archives/components-java-1.0/distributed-systems/local/>Local</a></li><li><a href=../../../../archives/components-java-1.0/distributed-systems/network/>Network</a></li><li><a href=../../../../archives/components-java-1.0/distributed-systems/remote/>Remote</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/components-java-1.0/extensions/>Extensions</a><ul class="nav docs-sidenav"><li><a href=../../../../archives/components-java-1.0/extensions/calypso/>Calypso</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/components-java-1.0/plugins/>Reader plugins</a><ul class="nav docs-sidenav"><li><a href=../../../../archives/components-java-1.0/plugins/nfc/>NFC</a></li><li><a href=../../../../archives/components-java-1.0/plugins/omapi/>OMAPI</a></li><li><a href=../../../../archives/components-java-1.0/plugins/pcsc/>PC/SC</a></li><li><a href=../../../../archives/components-java-1.0/plugins/stub/>Stub</a></li></ul></div></ul></div><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/components-cpp-0.9/>== C++ 0.x components ==</a><ul class="nav docs-sidenav"><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/components-cpp-0.9/core/>Core</a></div><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/components-cpp-0.9/extensions/>Extensions</a><ul class="nav docs-sidenav"><li><a href=../../../../archives/components-cpp-0.9/extensions/calypso/>Calypso</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=../../../../archives/components-cpp-0.9/plugins/>Reader plugins</a><ul class="nav docs-sidenav"><li><a href=../../../../archives/components-cpp-0.9/plugins/pcsc/>PC/SC</a></li><li><a href=../../../../archives/components-cpp-0.9/plugins/stub/>Stub</a></li></ul></div></ul></div></ul></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>Contents</a></li></ul><nav id=TableOfContents><ul><li><a href=#lets-code>Let&rsquo;s code</a><ul><li><a href=#create-the-class-skeleton>Create the class skeleton</a></li><li><a href=#configure-the-pcsc-plugin-and-the-readers>Configure the PC/SC plugin and the readers</a></li><li><a href=#select-the-calypso-sam>Select the Calypso SAM</a></li><li><a href=#select-the-calypso-po>Select the Calypso PO</a></li><li><a href=#open-the-calypso-secure-session>Open the Calypso secure session</a></li><li><a href=#close-the-calypso-secure-session>Close the Calypso secure session</a></li></ul></li><li><a href=#cmake-build>CMake build</a></li><li><a href=#run>Run</a></li><li><a href=#faq>FAQ</a><ul><li></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role=main><div class=docs-article-container></div><div class=docs-article-container><h1>Build your first C++ application</h1><article class=article-style><div class="alert alert-warning"><div>Version 1.0 of the documentation is no longer actively maintained. The site that you are currently viewing is an archived snapshot. For up-to-date documentation, see the latest version.</div></div><p>This quick start describes how to create a ready-to-execute C++
command-line application that runs a simple transaction based on
a Calypso portable object (PO) involving two smart card readers.</p><div class="alert alert-note"><div>The demonstration application created for this quick start requires a
Calypso PO (contactless smart card, mobile phone with contactless
communication) and a Calypso Secure Access Module (SAM).</div></div><p>We will use three main components of Keyple:</p><ul><li><a href=https://keyple.org/archives/components-cpp-0.9/core/>Keyple Core</a>
which is the base component to which all the others refer,</li><li><a href=https://keyple.org/archives/components-cpp-0.9/plugins/pcsc/>Keyple PC/SC plugin</a>
to provide the ability to manage PC/SC readers,</li><li><a href=https://keyple.org/archives/components-cpp-0.9/extensions/calypso/>Keyple Calypso extension</a>
to handle the commands sent to the Calypso PO and the Calypso SAM.</li></ul><p>In this guide CMake is used as build automation tool.</p><p>The example can run on any machine: Linux, Windows and macOS. If not installed in your machine, you
will need to download :</p><ul><li>CMake 2.8 or newer <a href=https://cmake.org/install/ target=_blank rel=noopener>(download)</a></li><li>GCC / CLang / MSVC compiler</li></ul><br><h2 id=lets-code>Let&rsquo;s code</h2><p>Now let&rsquo;s see step by step how to create in one single class the
elements that allow a certified reading of data through a Calypso secure
session.</p><p>In a real ticketing application, the organization of the code would
probably be different, but the point here is to show how Keyple makes it
possible to perform very simply operations that normally require a
quantity of code and knowledge that far exceeds what is implemented
here.</p><p>You can either progressively copy each of the small portions of code
that follow or copy the whole class at the bottom of this page.</p><h3 id=create-the-class-skeleton>Create the class skeleton</h3><p>Copy the source code below in a new C++ Class named
DemoPoAuthentication.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* Common */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;IllegalStateException.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;LoggerFactory.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* Core */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;ByteArrayUtil.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SeCommonProtocols.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SeSelector.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SeSelection.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SeProxyService.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* PCSC */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PcscPluginFactory.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PcscProtocolSetting.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PcscReader.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* Calypso */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;CalypsoPo.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;CalypsoSam.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;ElementaryFile.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PoSecuritySettings.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PoSelectionRequest.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PoSelector.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PoTransaction.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SamRevision.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SamSelector.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SamSelectionRequest.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>calypso</span><span class=o>::</span><span class=n>command</span><span class=o>::</span><span class=n>po</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>calypso</span><span class=o>::</span><span class=n>command</span><span class=o>::</span><span class=n>po</span><span class=o>::</span><span class=n>builder</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>calypso</span><span class=o>::</span><span class=n>command</span><span class=o>::</span><span class=n>po</span><span class=o>::</span><span class=n>parser</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>calypso</span><span class=o>::</span><span class=n>command</span><span class=o>::</span><span class=n>sam</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>calypso</span><span class=o>::</span><span class=n>transaction</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>common</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>common</span><span class=o>::</span><span class=n>exception</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>command</span><span class=o>::</span><span class=n>exception</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>selection</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>seproxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>seproxy</span><span class=o>::</span><span class=n>event</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>seproxy</span><span class=o>::</span><span class=n>exception</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>seproxy</span><span class=o>::</span><span class=n>message</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>seproxy</span><span class=o>::</span><span class=n>protocol</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>util</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>plugin</span><span class=o>::</span><span class=n>pcsc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argv</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=configure-the-pcsc-plugin-and-the-readers>Configure the PC/SC plugin and the readers</h3><p>The first step to use Keyple is to initialize the plugin and smart card readers.</p><p>In this snippet the PC/SC plugin is registered to the SmartCardService.</p><p>Two readers needs to be connected to the local machine. Replace
&ldquo;PO_READER_NAME&rdquo; and &ldquo;SAM_READER_NAME&rdquo; with the name of the USB readers.</p><p>If you don&rsquo;t know the names of the readers, read how to find them in the <a href=#faq>FAQ</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* ... */</span>
</span></span><span class=line><span class=cl><span class=cm>/* PO Reader name */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>PO_READER_NAME</span> <span class=o>=</span> <span class=s>&#34;XXX&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* SAM Reader name */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>SAM_READER_NAME</span> <span class=o>=</span> <span class=s>&#34;XXX&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Get the instance of the SeProxyService (Singleton pattern) */</span>
</span></span><span class=line><span class=cl><span class=n>SeProxyService</span><span class=o>&amp;</span> <span class=n>seProxyService</span> <span class=o>=</span> <span class=n>SeProxyService</span><span class=o>::</span><span class=n>getInstance</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Register the PcscPlugin with SeProxyService, get the corresponding generic ReaderPlugin */</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>pluginFactory</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>PcscPluginFactory</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>ReaderPlugin</span><span class=o>&gt;</span> <span class=n>readerPlugin</span> <span class=o>=</span> <span class=n>seProxyService</span><span class=p>.</span><span class=n>registerPlugin</span><span class=p>(</span><span class=n>pluginFactory</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Get the PO reader */</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>SeReader</span><span class=o>&gt;</span> <span class=n>poReader</span> <span class=o>=</span> <span class=n>readerPlugin</span><span class=o>-&gt;</span><span class=n>getReader</span><span class=p>(</span><span class=n>PO_READER_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Configure the PO reader parameters */</span>
</span></span><span class=line><span class=cl><span class=n>poReader</span><span class=o>-&gt;</span><span class=n>setParameter</span><span class=p>(</span><span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_KEY_PROTOCOL</span><span class=p>,</span> <span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_PROTOCOL_T1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Get a SAM reader */</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>SeReader</span><span class=o>&gt;</span> <span class=n>samReader</span> <span class=o>=</span> <span class=n>readerPlugin</span><span class=o>-&gt;</span><span class=n>getReader</span><span class=p>(</span><span class=n>SAM_READER_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Configure the SAM reader parameters */</span>
</span></span><span class=line><span class=cl><span class=n>samReader</span><span class=o>-&gt;</span><span class=n>setParameter</span><span class=p>(</span><span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_KEY_PROTOCOL</span><span class=p>,</span> <span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_PROTOCOL_T0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * PC/SC card access mode:
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * The SAM is left in the SHARED mode (by default) to avoid automatic resets due to the limited
</span></span></span><span class=line><span class=cl><span class=cm> * time between two consecutive exchanges granted by Windows.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * This point will be addressed in a coming release of the Keyple PcSc reader plugin.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * The PO reader is set to EXCLUSIVE mode to avoid side effects (on OS Windows 8+) during the
</span></span></span><span class=line><span class=cl><span class=cm> * selection step that may result in session failures.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * See KEYPLE-CORE.PC.md file to learn more about this point.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>samReader</span><span class=o>-&gt;</span><span class=n>setParameter</span><span class=p>(</span><span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_KEY_MODE</span><span class=p>,</span> <span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_MODE_SHARED</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>poReader</span><span class=o>-&gt;</span><span class=n>setParameter</span><span class=p>(</span><span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_KEY_MODE</span><span class=p>,</span> <span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_MODE_SHARED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Set the PO reader protocol flag */</span>
</span></span><span class=line><span class=cl><span class=n>poReader</span><span class=o>-&gt;</span><span class=n>addSeProtocolSetting</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_ISO14443_4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PcscProtocolSetting</span><span class=o>::</span><span class=n>PCSC_PROTOCOL_SETTING</span><span class=p>[</span><span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_ISO14443_4</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=n>poReader</span><span class=o>-&gt;</span><span class=n>addSeProtocolSetting</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_B_PRIME</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PcscProtocolSetting</span><span class=o>::</span><span class=n>PCSC_PROTOCOL_SETTING</span><span class=p>[</span><span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_B_PRIME</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=n>samReader</span><span class=o>-&gt;</span><span class=n>addSeProtocolSetting</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_ISO7816_3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PcscProtocolSetting</span><span class=o>::</span><span class=n>PCSC_PROTOCOL_SETTING</span><span class=p>[</span><span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_ISO7816_3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* ... */</span>
</span></span></code></pre></div><h3 id=select-the-calypso-sam>Select the Calypso SAM</h3><p>Before executing a transaction each smart card should be selected. The
next step is the selection of the Calypso SAM resulting in a
CalypsoSam object.</p><p>It is then combined with the SAM reader to form the SAM resource needed
later within the transaction service.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* ... */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Prepare the selector to ensure the correct SAM is used */</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>SamSelector</span><span class=o>::</span><span class=n>builder</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>samRevision</span><span class=p>(</span><span class=n>SamRevision</span><span class=o>::</span><span class=n>AUTO</span><span class=p>).</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>samSelector</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>dynamic_pointer_cast</span><span class=o>&lt;</span><span class=n>SamSelector</span><span class=o>&gt;</span><span class=p>(</span><span class=n>selector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Make the SAM selection */</span>
</span></span><span class=line><span class=cl><span class=n>SeSelection</span> <span class=n>samSelection</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>samSelectionRequest</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>SamSelectionRequest</span><span class=o>&gt;</span><span class=p>(</span><span class=n>samSelector</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>abstractSamSelectionRequest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>reinterpret_pointer_cast</span><span class=o>&lt;</span><span class=n>AbstractSeSelectionRequest</span><span class=o>&lt;</span><span class=n>AbstractApduCommandBuilder</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=n>samSelectionRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>samSelection</span><span class=p>.</span><span class=n>prepareSelection</span><span class=p>(</span><span class=n>abstractSamSelectionRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>CalypsoSam</span><span class=o>&gt;</span> <span class=n>calypsoSam</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>samReader</span><span class=o>-&gt;</span><span class=n>isSePresent</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>SelectionsResult</span><span class=o>&gt;</span> <span class=n>selectionsResult</span> <span class=o>=</span> <span class=n>samSelection</span><span class=p>.</span><span class=n>processExplicitSelection</span><span class=p>(</span><span class=n>samReader</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>selectionsResult</span><span class=o>-&gt;</span><span class=n>hasActiveSelection</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>calypsoSam</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>dynamic_pointer_cast</span><span class=o>&lt;</span><span class=n>CalypsoSam</span><span class=o>&gt;</span><span class=p>(</span><span class=n>selectionsResult</span><span class=o>-&gt;</span><span class=n>getActiveMatchingSe</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=nf>IllegalStateException</span><span class=p>(</span><span class=s>&#34;SAM matching failed!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=nf>IllegalStateException</span><span class=p>(</span><span class=s>&#34;No SAM is present in the reader &#34;</span> <span class=o>+</span> <span class=n>samReader</span><span class=o>-&gt;</span><span class=n>getName</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Associate the calypsoSam and the samReader to create the samResource */</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>samResource</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>SeResource</span><span class=o>&lt;</span><span class=n>CalypsoSam</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=n>samReader</span><span class=p>,</span> <span class=n>calypsoSam</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* ... */</span>
</span></span></code></pre></div><h3 id=select-the-calypso-po>Select the Calypso PO</h3><p>1st PO exchange:</p><p>The Calypso PO selection is made using the portable object application&rsquo;s AID
and results in a CalypsoPo object that will contain all the information extracted
from the Calypso PO all along the transaction.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* Prepare a Calypso PO selection */</span>
</span></span><span class=line><span class=cl><span class=n>SeSelection</span> <span class=n>seSelection</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Keyple test kit profile 1, Application 2 */</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>AID</span> <span class=o>=</span> <span class=s>&#34;315449432E49434131&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Setting of an AID based selection of a Calypso Revision 3.1 PO
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Select the first application matching the selection AID whatever the card communication
</span></span></span><span class=line><span class=cl><span class=cm> * protocol
</span></span></span><span class=line><span class=cl><span class=cm> * Keep the logical channel open after the selection
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Calypso selection: configures a PoSelectionRequest with all the desired attributes to
</span></span></span><span class=line><span class=cl><span class=cm> * make the selection and read additional information afterwards
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl> <span class=k>auto</span> <span class=n>aidSelector</span> <span class=o>=</span> <span class=n>SeSelector</span><span class=o>::</span><span class=n>AidSelector</span><span class=o>::</span><span class=n>builder</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>aidToSelect</span><span class=p>(</span><span class=n>AID</span><span class=p>).</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>seSelector</span> <span class=o>=</span> <span class=n>PoSelector</span><span class=o>::</span><span class=n>builder</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>aidSelector</span><span class=p>(</span><span class=n>aidSelector</span><span class=p>)</span> <span class=cm>/* The application identifier
</span></span></span><span class=line><span class=cl><span class=cm>                                         to indicate if an invalidated PO should be accepted
</span></span></span><span class=line><span class=cl><span class=cm>                                         or not */</span>
</span></span><span class=line><span class=cl>                                        <span class=p>.</span><span class=n>invalidatedPo</span><span class=p>(</span><span class=n>PoSelector</span><span class=o>::</span><span class=n>InvalidatedPo</span><span class=o>::</span><span class=n>REJECT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                        <span class=p>.</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>poSelector</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>dynamic_pointer_cast</span><span class=o>&lt;</span><span class=n>PoSelector</span><span class=o>&gt;</span><span class=p>(</span><span class=n>seSelector</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>poSelectionRequest</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>PoSelectionRequest</span><span class=o>&gt;</span><span class=p>(</span><span class=n>poSelector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Add the selection case to the current selection (we could have added other cases) */</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>abstractPoSelectionRequest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>reinterpret_pointer_cast</span><span class=o>&lt;</span><span class=n>AbstractSeSelectionRequest</span><span class=o>&lt;</span><span class=n>AbstractApduCommandBuilder</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=n>poSelectionRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>seSelection</span><span class=p>.</span><span class=n>prepareSelection</span><span class=p>(</span><span class=n>abstractPoSelectionRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>poReader</span><span class=o>-&gt;</span><span class=n>isSePresent</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Actual PO communication: operate through a single request the Calypso PO selection
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>CalypsoPo</span><span class=o>&gt;</span> <span class=n>calypsoPo</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>std</span><span class=o>::</span><span class=n>dynamic_pointer_cast</span><span class=o>&lt;</span><span class=n>CalypsoPo</span><span class=o>&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>seSelection</span><span class=p>.</span><span class=n>processExplicitSelection</span><span class=p>(</span><span class=n>poReader</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>getActiveMatchingSe</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* ... */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=k>const</span> <span class=n>Exception</span><span class=o>&amp;</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/* ... */</span>
</span></span></code></pre></div><h3 id=open-the-calypso-secure-session>Open the Calypso secure session</h3><p>2nd PO exchange :</p><p>The secure session opening operated by the PoTransaction service is
combined with the reading of the environment file (SFI=07h).</p><p>The mutual authentication process between Calypso PO and Calypso SAM is initiated transparently.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* Prepare the security settings used during the Calypso transaction */</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>poSecuritySettings</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>PoSecuritySettings</span><span class=o>::</span><span class=n>PoSecuritySettingsBuilder</span><span class=o>&gt;</span><span class=p>(</span><span class=n>samResource</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Create a PoTransaction object to manage the Calypso transaction */</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>poTransaction</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>PoTransaction</span><span class=o>&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                            <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>SeResource</span><span class=o>&lt;</span><span class=n>CalypsoPo</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=n>poReader</span><span class=p>,</span> <span class=n>calypsoPo</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                            <span class=n>poSecuritySettings</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>uint8_t</span> <span class=n>RECORD_NUMBER_1</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>uint8_t</span> <span class=n>SFI_Environment</span> <span class=o>=</span> <span class=mh>0x07</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Read the Environment file at the Session Opening (we could have added other commands) */</span>
</span></span><span class=line><span class=cl><span class=n>poTransaction</span><span class=o>-&gt;</span><span class=n>prepareReadRecordFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>SFI_Environment</span><span class=p>,</span> <span class=cm>/* The sfi to select */</span>
</span></span><span class=line><span class=cl>        <span class=n>RECORD_NUMBER_1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Open Session with the debit key */</span>
</span></span><span class=line><span class=cl><span class=n>poTransaction</span><span class=o>-&gt;</span><span class=n>processOpening</span><span class=p>(</span><span class=n>PoTransaction</span><span class=o>::</span><span class=n>SessionSetting</span><span class=o>::</span><span class=n>AccessLevel</span><span class=o>::</span><span class=n>SESSION_LVL_DEBIT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Get the Environment data */</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>ElementaryFile</span><span class=o>&gt;</span> <span class=n>efEnvironment</span> <span class=o>=</span> <span class=n>calypsoPo</span><span class=o>-&gt;</span><span class=n>getFileBySfi</span><span class=p>(</span><span class=n>SFI_Environment</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>environmentLog</span> <span class=o>=</span> <span class=n>ByteArrayUtil</span><span class=o>::</span><span class=n>toHex</span><span class=p>(</span><span class=n>efEnvironment</span><span class=o>-&gt;</span><span class=n>getData</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getContent</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* ... */</span>
</span></span></code></pre></div><h3 id=close-the-calypso-secure-session>Close the Calypso secure session</h3><p>3rd PO exchange:</p><p>Simply close the Calypso secure session</p><p>The mutual authentication is finalized, it includes the authentication
of the data in the read file.</p><p>Note: any technical, crytographic or content-related incident in the Calypso PO
would be signalled by an exception and would interrupt the thread of
execution.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/* Schedule the closure of the channel with the PO after the closing of the secure session */</span>
</span></span><span class=line><span class=cl><span class=n>poTransaction</span><span class=o>-&gt;</span><span class=n>prepareReleasePoChannel</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Perform the closing of the Calypso Secure Session */</span>
</span></span><span class=line><span class=cl><span class=n>poTransaction</span><span class=o>-&gt;</span><span class=n>processClosing</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* ... */</span>
</span></span></code></pre></div><p>Find the complete code source <a href=#full-code>below</a>.</p><br><h2 id=cmake-build>CMake build</h2><p>Create a CMakeLists.txt file as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#
</span></span></span><span class=line><span class=cl><span class=cp># Copyright (c) 2020 Calypso Networks Association https:</span><span class=c1>//www.calypsonet-asso.org/
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#
</span></span></span><span class=line><span class=cl><span class=cp># All rights reserved. This program and the accompanying materials are made available under the
</span></span></span><span class=line><span class=cl><span class=cp># terms of the Eclipse Public License version 2.0 which accompanies this distribution, and is
</span></span></span><span class=line><span class=cl><span class=cp># available at https:</span><span class=c1>//www.eclipse.org/org/documents/epl-2.0/EPL-2.0.html
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>CMAKE_MINIMUM_REQUIRED</span><span class=p>(</span><span class=n>VERSION</span> <span class=mf>2.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_LEGACY_CYGWIN_WIN32</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_MACOSX_RPATH</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_CXX_STANDARD</span> <span class=mi>11</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_C_COMPILER_WORKS</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_CXX_COMPILER_WORKS</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PROJECT</span><span class=p>(</span><span class=n>KeypleDemo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SET</span><span class=p>(</span><span class=n>KEYPLE_SOURCE_DIR</span> <span class=s>&#34;&lt;path_to_keyple_repos&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>INCLUDE_DIRECTORIES</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>CMAKE_CURRENT_SOURCE_DIR</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cp># Core
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>core</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>command</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>core</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>command</span><span class=o>/</span><span class=n>exception</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>core</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>selection</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>core</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>seproxy</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>core</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>seproxy</span><span class=o>/</span><span class=n>event</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>core</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>seproxy</span><span class=o>/</span><span class=n>exception</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>core</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>seproxy</span><span class=o>/</span><span class=n>message</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>core</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>seproxy</span><span class=o>/</span><span class=n>protocol</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>core</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>util</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>core</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>util</span><span class=o>/</span><span class=n>bertlv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cp># Plugin
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>plugin</span><span class=o>/</span><span class=n>pcsc</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cp># Common
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>common</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>common</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>exception</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cp># Calypso
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>calypso</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>calypso</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>command</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>calypso</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>command</span><span class=o>/</span><span class=n>po</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>calypso</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>command</span><span class=o>/</span><span class=n>po</span><span class=o>/</span><span class=n>builder</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>calypso</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>command</span><span class=o>/</span><span class=n>po</span><span class=o>/</span><span class=n>parser</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>calypso</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>command</span><span class=o>/</span><span class=n>sam</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>KEYPLE_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>component</span><span class=o>/</span><span class=n>keyple</span><span class=o>-</span><span class=n>calypso</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>transaction</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cp># pcsc (Linux / macOS)
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>include</span><span class=o>/</span><span class=n>PCSC</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>IF</span><span class=p>(</span><span class=n>WIN32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_FIND_LIBRARY_PREFIXES</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_FIND_LIBRARY_SUFFIXES</span> <span class=s>&#34;.dll&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_BUILD_DIRECTORY</span> <span class=s>&#34;${CMAKE_CURRENT_BINARY_DIR}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>SET</span><span class=p>(</span><span class=n>WINSCARD</span> <span class=n>winscard</span><span class=p>.</span><span class=n>lib</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ENDIF</span><span class=p>(</span><span class=n>WIN32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>IF</span><span class=p>(</span><span class=n>APPLE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_FIND_LIBRARY_PREFIXES</span> <span class=s>&#34;lib&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_FIND_LIBRARY_SUFFIXES</span> <span class=s>&#34;.dylib&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>SET</span><span class=p>(</span><span class=n>CMAKE_BUILD_DIRECTORY</span> <span class=s>&#34;${CMAKE_CURRENT_BINARY_DIR}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>SET</span><span class=p>(</span><span class=n>WINSCARD</span> <span class=s>&#34;-framework PCSC&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ENDIF</span><span class=p>(</span><span class=n>APPLE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>IF</span><span class=p>(</span><span class=n>UNIX</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>SET</span><span class=p>(</span><span class=n>SPEC_LIBS</span> <span class=n>pthread</span> <span class=n>pcsclite</span> <span class=n>rt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ENDIF</span><span class=p>(</span><span class=n>UNIX</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>IF</span><span class=p>(</span><span class=n>APPLE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>SET</span><span class=p>(</span><span class=n>SPEC_LIBS</span> <span class=n>pthread</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ENDIF</span><span class=p>(</span><span class=n>APPLE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ADD_EXECUTABLE</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>demo_po_authentication</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=p>{</span><span class=n>CMAKE_CURRENT_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>main</span><span class=p>.</span><span class=n>cpp</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TARGET_LINK_DIRECTORIES</span><span class=p>(</span><span class=n>demo_po_authentication</span> <span class=n>PUBLIC</span> <span class=err>$</span><span class=p>{</span><span class=n>CMAKE_CURRENT_SOURCE_DIR</span><span class=p>}</span><span class=o>/</span><span class=n>build</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>TARGET_LINK_LIBRARIES</span><span class=p>(</span><span class=n>demo_po_authentication</span> <span class=n>keyplecommon</span> <span class=n>keyplepluginpcsc</span> <span class=n>keyplecore</span> <span class=n>keyplecalypso</span> <span class=err>$</span><span class=p>{</span><span class=n>SPEC_LIBS</span><span class=p>})</span>
</span></span></code></pre></div><p>Now build the demo code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir build
</span></span><span class=line><span class=cl><span class=nb>cd</span> build
</span></span><span class=line><span class=cl>cmake ..
</span></span><span class=line><span class=cl>make
</span></span></code></pre></div><br><h2 id=run>Run</h2><ol><li>Connect two USB PC/SC Readers.</li><li>Insert the Calypso SAM in the SAM reader.</li><li>Insert the Calypso PO in the PO reader.</li><li>Run the application.</li></ol><br><h2 id=faq>FAQ</h2><p><strong>How do I find out the names of the readers?</strong></p><p>If you dont know the reader name, several options:</p><ul><li>run the application in debug mode and get the reader name in plugin variable</li><li>run &lsquo;pcsctest&rsquo; (macOS)</li><li>run &lsquo;pcsc_scan&rsquo; (Linux)</li></ul><p>Identify which reader will be the PO (contactless) reader and the SAM
(contact) reader and replace <code>PO_READER_NAME</code> and
<code>SAM_READER_NAME</code> with their values.</p><p><strong>How to activate the Keyple&rsquo;s logs?</strong></p><p>Logs are automatically activated but log level can be dynamically changed by a simple call to the
Logger::setLevel() function. Default value is Logger::Level::logDebug.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>DemoPoAuthentication</span> <span class=k>final</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Logger</span><span class=o>&gt;</span> <span class=n>logger</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>::</span><span class=n>getLogger</span><span class=p>(</span><span class=k>typeid</span><span class=p>(</span><span class=n>DemoPoAuthentication</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>-&gt;</span><span class=n>setLoggerLevel</span><span class=p>(</span><span class=n>Logger</span><span class=o>::</span><span class=n>Level</span><span class=o>::</span><span class=n>logError</span><span class=p>);</span>
</span></span></code></pre></div><h4 id=full-code>Full code</h4><p>Here is the complete code of this quick start in one single block.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/**************************************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm> * Copyright (c) 2020 Calypso Networks Association                                                *
</span></span></span><span class=line><span class=cl><span class=cm> * https://www.calypsonet-asso.org/                                                               *
</span></span></span><span class=line><span class=cl><span class=cm> *                                                                                                *
</span></span></span><span class=line><span class=cl><span class=cm> * See the NOTICE file(s) distributed with this work for additional information regarding         *
</span></span></span><span class=line><span class=cl><span class=cm> * copyright ownership.                                                                           *
</span></span></span><span class=line><span class=cl><span class=cm> *                                                                                                *
</span></span></span><span class=line><span class=cl><span class=cm> * This program and the accompanying materials are made available under the terms of the Eclipse  *
</span></span></span><span class=line><span class=cl><span class=cm> * Public License 2.0 which is available at http://www.eclipse.org/legal/epl-2.0                  *
</span></span></span><span class=line><span class=cl><span class=cm> *                                                                                                *
</span></span></span><span class=line><span class=cl><span class=cm> * SPDX-License-Identifier: EPL-2.0                                                               *
</span></span></span><span class=line><span class=cl><span class=cm> **************************************************************************************************/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Common */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;IllegalStateException.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;LoggerFactory.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* Core */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;ByteArrayUtil.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SeCommonProtocols.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SeSelector.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SeSelection.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SeProxyService.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* PCSC */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PcscPluginFactory.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PcscProtocolSetting.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PcscReader.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* Calypso */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;CalypsoPo.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;CalypsoSam.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;ElementaryFile.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PoSecuritySettings.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PoSelectionRequest.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PoSelector.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;PoTransaction.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SamRevision.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SamSelector.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;SamSelectionRequest.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>calypso</span><span class=o>::</span><span class=n>command</span><span class=o>::</span><span class=n>po</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>calypso</span><span class=o>::</span><span class=n>command</span><span class=o>::</span><span class=n>po</span><span class=o>::</span><span class=n>builder</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>calypso</span><span class=o>::</span><span class=n>command</span><span class=o>::</span><span class=n>po</span><span class=o>::</span><span class=n>parser</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>calypso</span><span class=o>::</span><span class=n>command</span><span class=o>::</span><span class=n>sam</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>calypso</span><span class=o>::</span><span class=n>transaction</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>common</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>common</span><span class=o>::</span><span class=n>exception</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>command</span><span class=o>::</span><span class=n>exception</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>selection</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>seproxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>seproxy</span><span class=o>::</span><span class=n>event</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>seproxy</span><span class=o>::</span><span class=n>exception</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>seproxy</span><span class=o>::</span><span class=n>message</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>seproxy</span><span class=o>::</span><span class=n>protocol</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>core</span><span class=o>::</span><span class=n>util</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>keyple</span><span class=o>::</span><span class=n>plugin</span><span class=o>::</span><span class=n>pcsc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DemoPoAuthentication</span> <span class=k>final</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>Logger</span><span class=o>&gt;</span> <span class=n>logger</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>::</span><span class=n>getLogger</span><span class=p>(</span><span class=k>typeid</span><span class=p>(</span><span class=n>DemoPoAuthentication</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// PO Reader name
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>PO_READER_NAME</span> <span class=o>=</span> <span class=s>&#34;XXX&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SAM Reader name
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>SAM_READER_NAME</span> <span class=o>=</span> <span class=s>&#34;XXX&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Keyple test kit profile 1, Application 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>AID</span> <span class=o>=</span> <span class=s>&#34;315449432E49434131&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>uint8_t</span> <span class=n>RECORD_NUMBER_1</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>uint8_t</span> <span class=n>SFI_Environment</span> <span class=o>=</span> <span class=mh>0x07</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argv</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Get the instance of the SeProxyService (Singleton pattern)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SeProxyService</span><span class=o>&amp;</span> <span class=n>seProxyService</span> <span class=o>=</span> <span class=n>SeProxyService</span><span class=o>::</span><span class=n>getInstance</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                  Get and Configure the PO &amp; SAM Readers                  =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Register the PcscPlugin with SeProxyService, get the corresponding generic ReaderPlugin
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>auto</span> <span class=n>pluginFactory</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>PcscPluginFactory</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>ReaderPlugin</span><span class=o>&gt;</span> <span class=n>readerPlugin</span> <span class=o>=</span> <span class=n>seProxyService</span><span class=p>.</span><span class=n>registerPlugin</span><span class=p>(</span><span class=n>pluginFactory</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Get the PO reader
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>SeReader</span><span class=o>&gt;</span> <span class=n>poReader</span> <span class=o>=</span> <span class=n>readerPlugin</span><span class=o>-&gt;</span><span class=n>getReader</span><span class=p>(</span><span class=n>PO_READER_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Get a SAM reader
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>SeReader</span><span class=o>&gt;</span> <span class=n>samReader</span> <span class=o>=</span> <span class=n>readerPlugin</span><span class=o>-&gt;</span><span class=n>getReader</span><span class=p>(</span><span class=n>SAM_READER_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Eventually, configure the SAM reader parameters
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Set Pcsc settings per reader */</span>
</span></span><span class=line><span class=cl>    <span class=n>poReader</span><span class=o>-&gt;</span><span class=n>setParameter</span><span class=p>(</span><span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_KEY_PROTOCOL</span><span class=p>,</span> <span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_PROTOCOL_T1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>samReader</span><span class=o>-&gt;</span><span class=n>setParameter</span><span class=p>(</span><span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_KEY_PROTOCOL</span><span class=p>,</span> <span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_PROTOCOL_T0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * PC/SC card access mode:
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * The SAM is left in the SHARED mode (by default) to avoid automatic resets due to the limited
</span></span></span><span class=line><span class=cl><span class=cm>     * time between two consecutive exchanges granted by Windows.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * This point will be addressed in a coming release of the Keyple PcSc reader plugin.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * The PO reader is set to EXCLUSIVE mode to avoid side effects (on OS Windows 8+) during the
</span></span></span><span class=line><span class=cl><span class=cm>     * selection step that may result in session failures.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * See KEYPLE-CORE.PC.md file to learn more about this point.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=n>samReader</span><span class=o>-&gt;</span><span class=n>setParameter</span><span class=p>(</span><span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_KEY_MODE</span><span class=p>,</span> <span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_MODE_SHARED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>poReader</span><span class=o>-&gt;</span><span class=n>setParameter</span><span class=p>(</span><span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_KEY_MODE</span><span class=p>,</span> <span class=n>PcscReader</span><span class=o>::</span><span class=n>SETTING_MODE_SHARED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Set the PO reader protocol flag */</span>
</span></span><span class=line><span class=cl>    <span class=n>poReader</span><span class=o>-&gt;</span><span class=n>addSeProtocolSetting</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_ISO14443_4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>PcscProtocolSetting</span><span class=o>::</span><span class=n>PCSC_PROTOCOL_SETTING</span><span class=p>[</span><span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_ISO14443_4</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>poReader</span><span class=o>-&gt;</span><span class=n>addSeProtocolSetting</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_B_PRIME</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>PcscProtocolSetting</span><span class=o>::</span><span class=n>PCSC_PROTOCOL_SETTING</span><span class=p>[</span><span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_B_PRIME</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>samReader</span><span class=o>-&gt;</span><span class=n>addSeProtocolSetting</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_ISO7816_3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>PcscProtocolSetting</span><span class=o>::</span><span class=n>PCSC_PROTOCOL_SETTING</span><span class=p>[</span><span class=n>SeCommonProtocols</span><span class=o>::</span><span class=n>PROTOCOL_ISO7816_3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=              Create a SAM resource after selecting the SAM               =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Prepare the selector to ensure the correct SAM is used
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>auto</span> <span class=n>selector</span> <span class=o>=</span> <span class=n>SamSelector</span><span class=o>::</span><span class=n>builder</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>samRevision</span><span class=p>(</span><span class=n>SamRevision</span><span class=o>::</span><span class=n>AUTO</span><span class=p>).</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>samSelector</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>dynamic_pointer_cast</span><span class=o>&lt;</span><span class=n>SamSelector</span><span class=o>&gt;</span><span class=p>(</span><span class=n>selector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Make the SAM selection
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SeSelection</span> <span class=n>samSelection</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>samSelectionRequest</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>SamSelectionRequest</span><span class=o>&gt;</span><span class=p>(</span><span class=n>samSelector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>abstractSamSelectionRequest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>reinterpret_pointer_cast</span><span class=o>&lt;</span><span class=n>AbstractSeSelectionRequest</span><span class=o>&lt;</span><span class=n>AbstractApduCommandBuilder</span><span class=o>&gt;&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>samSelectionRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>samSelection</span><span class=p>.</span><span class=n>prepareSelection</span><span class=p>(</span><span class=n>abstractSamSelectionRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>CalypsoSam</span><span class=o>&gt;</span> <span class=n>calypsoSam</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>samReader</span><span class=o>-&gt;</span><span class=n>isSePresent</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>SelectionsResult</span><span class=o>&gt;</span> <span class=n>selectionsResult</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>samSelection</span><span class=p>.</span><span class=n>processExplicitSelection</span><span class=p>(</span><span class=n>samReader</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>selectionsResult</span><span class=o>-&gt;</span><span class=n>hasActiveSelection</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>calypsoSam</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>dynamic_pointer_cast</span><span class=o>&lt;</span><span class=n>CalypsoSam</span><span class=o>&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>selectionsResult</span><span class=o>-&gt;</span><span class=n>getActiveMatchingSe</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;SAM matching failed!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;No SAM is present in the reader &#34;</span> <span class=o>+</span> <span class=n>samReader</span><span class=o>-&gt;</span><span class=n>getName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Associate the calypsoSam and the samReader to create the samResource
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>auto</span> <span class=n>samResource</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>SeResource</span><span class=o>&lt;</span><span class=n>CalypsoSam</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=n>samReader</span><span class=p>,</span> <span class=n>calypsoSam</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Prepare the security settings used during the Calypso transaction
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>auto</span> <span class=n>poSecuritySettings</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>PoSecuritySettings</span><span class=o>::</span><span class=n>PoSecuritySettingsBuilder</span><span class=o>&gt;</span><span class=p>(</span><span class=n>samResource</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=           Display basic information about the readers and SAM            =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;= PO Reader Name = %</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>poReader</span><span class=o>-&gt;</span><span class=n>getName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>samSerialNumber</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>ByteArrayUtil</span><span class=o>::</span><span class=n>toHex</span><span class=p>(</span><span class=n>samResource</span><span class=o>-&gt;</span><span class=n>getMatchingSe</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getSerialNumber</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;= SAM Reader Name = %, Serial Number = %</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>samResource</span><span class=o>-&gt;</span><span class=n>getSeReader</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getName</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                 <span class=n>samSerialNumber</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                     Prepare the Calypso PO selection                     =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Prepare a Calypso PO selection
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>SeSelection</span> <span class=n>seSelection</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Setting of an AID based selection of a Calypso Revision 3.1 PO
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Select the first application matching the selection AID whatever the card communication
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// protocol
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Keep the logical channel open after the selection
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Calypso selection: configures a PoSelectionRequest with all the desired attributes to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// make the selection and read additional information afterwards
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>auto</span> <span class=n>aidSelector</span> <span class=o>=</span> <span class=n>SeSelector</span><span class=o>::</span><span class=n>AidSelector</span><span class=o>::</span><span class=n>builder</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>aidToSelect</span><span class=p>(</span><span class=n>AID</span><span class=p>).</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>seSelector</span> <span class=o>=</span> <span class=n>PoSelector</span><span class=o>::</span><span class=n>builder</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>aidSelector</span><span class=p>(</span><span class=n>aidSelector</span><span class=p>)</span> <span class=c1>// the application identifier
</span></span></span><span class=line><span class=cl><span class=c1></span>                                            <span class=c1>// to indicate if an invalidated PO should be accepted
</span></span></span><span class=line><span class=cl><span class=c1></span>                                            <span class=c1>// or not
</span></span></span><span class=line><span class=cl><span class=c1></span>                                            <span class=p>.</span><span class=n>invalidatedPo</span><span class=p>(</span><span class=n>PoSelector</span><span class=o>::</span><span class=n>InvalidatedPo</span><span class=o>::</span><span class=n>REJECT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                            <span class=p>.</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>poSelector</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>dynamic_pointer_cast</span><span class=o>&lt;</span><span class=n>PoSelector</span><span class=o>&gt;</span><span class=p>(</span><span class=n>seSelector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>poSelectionRequest</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>PoSelectionRequest</span><span class=o>&gt;</span><span class=p>(</span><span class=n>poSelector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Add the selection case to the current selection
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// (we could have added other cases)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>auto</span> <span class=n>abstractPoSelectionRequest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>reinterpret_pointer_cast</span><span class=o>&lt;</span><span class=n>AbstractSeSelectionRequest</span><span class=o>&lt;</span><span class=n>AbstractApduCommandBuilder</span><span class=o>&gt;&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>poSelectionRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>seSelection</span><span class=p>.</span><span class=n>prepareSelection</span><span class=p>(</span><span class=n>abstractPoSelectionRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                  Check if a PO is present in the reader                  =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>poReader</span><span class=o>-&gt;</span><span class=n>isSePresent</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                    Start of the Calypso PO processing                    =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                             1st PO exchange                              =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                           AID based selection                            =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Actual PO communication: operate through a single request the Calypso PO selection
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>CalypsoPo</span><span class=o>&gt;</span> <span class=n>calypsoPo</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>std</span><span class=o>::</span><span class=n>dynamic_pointer_cast</span><span class=o>&lt;</span><span class=n>CalypsoPo</span><span class=o>&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>seSelection</span><span class=p>.</span><span class=n>processExplicitSelection</span><span class=p>(</span><span class=n>poReader</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>getActiveMatchingSe</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;The selection of the PO has succeeded</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                            2nd PO exchange                               =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                     Open a Calypso secure session                        =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                  Reading of Environment file (SFI=07h)                   =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Create a PoTransaction object to manage the Calypso transaction
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>auto</span> <span class=n>poTransaction</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>PoTransaction</span><span class=o>&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                     <span class=n>std</span><span class=o>::</span><span class=n>make_shared</span><span class=o>&lt;</span><span class=n>SeResource</span><span class=o>&lt;</span><span class=n>CalypsoPo</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=n>poReader</span><span class=p>,</span> <span class=n>calypsoPo</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                                     <span class=n>poSecuritySettings</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Read the Environment file at the Session Opening
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// (we could have added other commands)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>poTransaction</span><span class=o>-&gt;</span><span class=n>prepareReadRecordFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>SFI_Environment</span><span class=p>,</span> <span class=c1>// the sfi to select
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>RECORD_NUMBER_1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Open Session with the debit key
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>poTransaction</span><span class=o>-&gt;</span><span class=n>processOpening</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>PoTransaction</span><span class=o>::</span><span class=n>SessionSetting</span><span class=o>::</span><span class=n>AccessLevel</span><span class=o>::</span><span class=n>SESSION_LVL_DEBIT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Get the Environment data
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>ElementaryFile</span><span class=o>&gt;</span> <span class=n>efEnvironment</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>calypsoPo</span><span class=o>-&gt;</span><span class=n>getFileBySfi</span><span class=p>(</span><span class=n>SFI_Environment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>environmentLog</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>ByteArrayUtil</span><span class=o>::</span><span class=n>toHex</span><span class=p>(</span><span class=n>efEnvironment</span><span class=o>-&gt;</span><span class=n>getData</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getContent</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;File Environment log: %</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>environmentLog</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>calypsoPo</span><span class=o>-&gt;</span><span class=n>isDfRatified</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============= Previous Calypso Secure Session was not ratified =============</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                            3th PO exchange                               =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                     Close the Calypso secure session                     =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// To close the channel with the PO after the closing
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>poTransaction</span><span class=o>-&gt;</span><span class=n>prepareReleasePoChannel</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Close the Calypso Secure Session
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// A ratification command will be sent (CONTACTLESS_MODE)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>poTransaction</span><span class=o>-&gt;</span><span class=n>processClosing</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=              The Calypso secure session ended successfully               =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                   (Successful mutual authentication)                     =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;=                    End of the Calypso PO processing                      =</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>(</span><span class=s>&#34;============================================================================</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=k>const</span> <span class=n>Exception</span><span class=o>&amp;</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>-&gt;</span><span class=n>error</span><span class=p>(</span><span class=s>&#34;Exception: %</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>.</span><span class=n>getMessage</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>-&gt;</span><span class=n>error</span><span class=p>(</span><span class=s>&#34;The selection of the PO has failed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=sample-trace>Sample trace</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                  Get and Configure the PO <span class=p>&amp;</span> SAM <span class=nv>Readers</span>                  <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl>initNativeReaders - getting card terminals
</span></span><span class=line><span class=cl>run - starting executor monitoring thread
</span></span><span class=line><span class=cl><span class=o>[</span>PcscReaderImpl<span class=o>]</span> <span class=nv>constructor</span> <span class=o>=</span>&gt; using terminal OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span>transmission_mode, <span class=nv>VALUE</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> protocol, <span class=nv>VALUE</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> mode, <span class=nv>VALUE</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> disconnect, <span class=nv>VALUE</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>run - starting executor monitoring thread
</span></span><span class=line><span class=cl><span class=nv>constructor</span> <span class=o>=</span>&gt; using terminal OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> transmission_mode, <span class=nv>VALUE</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> protocol, <span class=nv>VALUE</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> mode, <span class=nv>VALUE</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> disconnect, <span class=nv>VALUE</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>Registering a new Plugin to the platform : PcscPlugin
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> protocol, <span class=nv>VALUE</span> <span class=o>=</span> T1
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> protocol, <span class=nv>VALUE</span> <span class=o>=</span> T0
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> mode, <span class=nv>VALUE</span> <span class=o>=</span> shared
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>setParameter</span> <span class=o>=</span>&gt; PCSC: Set a parameter. <span class=nv>NAME</span> <span class=o>=</span> mode, <span class=nv>VALUE</span> <span class=o>=</span> <span class=nv>shared</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span>              Create a SAM resource after selecting the <span class=nv>SAM</span>               <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl>protocolFlagMatches - physical channel not open, opening it
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> openAndConnect - protocol: <span class=nv>T</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>openAndConnect - connecting tp OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)</span> with protocol: <span class=nv>T</span><span class=o>=</span>0, connectProtocol: <span class=m>1</span>
</span></span><span class=line><span class=cl>    and sharingMode: <span class=m>2</span>
</span></span><span class=line><span class=cl>openAndConnect - card state: <span class=m>84</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> Opening of a physical SE channel in shared mode
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>protocolFlagMatches</span> <span class=o>=</span>&gt; matching SE. <span class=nv>PROTOCOLFLAG</span> <span class=o>=</span> SEPROTOCOL:
</span></span><span class=line><span class=cl>    <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> ISO 7816-3, <span class=nv>TRANMISSIONMODE</span> <span class=o>=</span> CONTACTS<span class=o>}</span>
</span></span><span class=line><span class=cl>processSeRequestSet - processing requests <span class=nb>set</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processSeRequests</span> <span class=o>=</span>&gt; transmit SEREQUEST: <span class=o>{</span><span class=nv>REQUESTS</span> <span class=o>=</span> ApduRequests: <span class=o>{}</span>,
</span></span><span class=line><span class=cl>    <span class=nv>SELECTOR</span> <span class=o>=</span> SESELECTOR: <span class=o>{</span>SEPROTOCOL: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> ISO 7816-3, <span class=nv>TRANMISSIONMODE</span> <span class=o>=</span> CONTACTS<span class=o>}</span><span class=nv>AIDSELECTOR</span> <span class=o>=</span> null,
</span></span><span class=line><span class=cl>    ATRFILTER: <span class=o>{</span><span class=nv>REGEX</span> <span class=o>=</span> .*<span class=o>}}}</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processSeRequest</span> <span class=o>=</span>&gt; Logical channel <span class=nv>open</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processSeRequests</span> <span class=o>=</span>&gt; receive SERESPONSE: <span class=o>{</span><span class=nv>RESPONSES</span> <span class=o>=</span> APDURESPONSES: <span class=o>{}</span>,
</span></span><span class=line><span class=cl>     <span class=nv>SELECTIONSTATUS</span> <span class=o>=</span> SELECTIONSTATUS: <span class=o>{</span><span class=nv>ATR</span> <span class=o>=</span> <span class=nv>ATR</span> <span class=o>=</span> 3b3f9600805a4880c1205017aec11a36829000, <span class=nv>FCI</span> <span class=o>=</span> R-APDU:
</span></span><span class=line><span class=cl>     <span class=o>{</span><span class=nv>STATUS</span> <span class=o>=</span> FAILURE, BYTES <span class=o>(</span>0<span class=o>)</span> <span class=o>=</span> <span class=o>}</span>, <span class=nv>HASMATCHED</span> <span class=o>=</span> 1<span class=o>}</span>, <span class=nv>CHANNELWASOPEN</span> <span class=o>=</span> 0<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span>           Display basic information about the readers and <span class=nv>SAM</span>            <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span> PO Reader <span class=nv>Name</span> <span class=o>=</span> OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>=</span> SAM Reader <span class=nv>Name</span> <span class=o>=</span> OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)</span>, Serial <span class=nv>Number</span> <span class=o>=</span> <span class=nv>AEC11A36</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                     Prepare the Calypso PO <span class=nv>selection</span>                     <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                  Check <span class=k>if</span> a PO is present in the <span class=nv>reader</span>                  <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                    Start of the Calypso PO <span class=nv>processing</span>                    <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                             1st PO <span class=nv>exchange</span>                              <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                           AID based <span class=nv>selection</span>                            <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl>protocolFlagMatches - physical channel not open, opening it
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> openAndConnect - protocol: <span class=nv>T</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>openAndConnect - connecting tp OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)</span> with protocol: <span class=nv>T</span><span class=o>=</span>1, connectProtocol: <span class=m>2</span>
</span></span><span class=line><span class=cl>    and sharingMode: <span class=m>2</span>
</span></span><span class=line><span class=cl>openAndConnect - card state: <span class=m>84</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> Opening of a physical SE channel in shared mode
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>protocolFlagMatches</span> <span class=o>=</span>&gt; matching SE. <span class=nv>PROTOCOLFLAG</span> <span class=o>=</span> SEPROTOCOL:
</span></span><span class=line><span class=cl>    <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> ISO 14443-4, <span class=nv>TRANMISSIONMODE</span> <span class=o>=</span> CONTACTLESS<span class=o>}</span>
</span></span><span class=line><span class=cl>processSeRequestSet - processing requests <span class=nb>set</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>processSeRequests</span> <span class=o>=</span>&gt; transmit SEREQUEST: <span class=o>{</span><span class=nv>REQUESTS</span> <span class=o>=</span> ApduRequests:
</span></span><span class=line><span class=cl>    <span class=o>{}</span>, <span class=nv>SELECTOR</span> <span class=o>=</span> SESELECTOR: <span class=o>{</span>SEPROTOCOL: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> ISO 14443-4, <span class=nv>TRANMISSIONMODE</span> <span class=o>=</span> CONTACTLESS<span class=o>}</span>AIDSELECTOR:
</span></span><span class=line><span class=cl>    <span class=o>{</span><span class=nv>AIDTOSELECT</span> <span class=o>=</span> 315449432e49434131FILEOCCURRENCE: <span class=o>{</span><span class=nv>ISOBITMASK</span> <span class=o>=</span> 0<span class=o>(</span>0x00<span class=o>)}</span>FILECONTROLINFORMATION:
</span></span><span class=line><span class=cl>    <span class=o>{</span><span class=nv>ISOBITMASK</span> <span class=o>=</span> 0<span class=o>(</span>0x00<span class=o>)}</span>0x0<span class=o>}</span>, <span class=nv>ATRFILTER</span> <span class=o>=</span> null<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>processSeRequest</span> <span class=o>=</span>&gt; Logical channel <span class=nv>open</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>openLogicalChannel</span> <span class=o>=</span>&gt; Select Application with <span class=nv>AID</span> <span class=o>=</span> 315449432e49434131
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>processApduRequest</span> <span class=o>=</span>&gt; APDUREQUEST: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> Internal Select Application,
</span></span><span class=line><span class=cl>    <span class=nv>RAWDATA</span> <span class=o>=</span> 00a4040009315449432e4943413100, <span class=nv>CASE4</span> <span class=o>=</span> 1<span class=o>}</span>, elapsed 13c ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> transmitApdu - c-apdu &gt;&gt; 00a4040009315449432e4943413100
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> transmitApdu - r-apdu <span class=s>&lt;&lt;
</span></span></span><span class=line><span class=cl><span class=s>    6f238409315449432e49434131a516bf0c13c70800000000c17be1f653070a3c23051410019000
</span></span></span><span class=line><span class=cl><span class=s>[OMNIKEY CardMan (076B:5421) 5421(2)] processApduRequest =&gt; R-APDU: {STATUS = SUCCESS, BYTES (39) = 6f238409315449432e49434131a516bf0c13c70800000000c17be1f653070a3c23051410019000</span><span class=o>}</span>, elapsed c ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>processSeRequests</span> <span class=o>=</span>&gt; receive SERESPONSE: <span class=o>{</span><span class=nv>RESPONSES</span> <span class=o>=</span> APDURESPONSES: <span class=o>{}</span>,
</span></span><span class=line><span class=cl>    <span class=nv>SELECTIONSTATUS</span> <span class=o>=</span> SELECTIONSTATUS: <span class=o>{</span><span class=nv>ATR</span> <span class=o>=</span> <span class=nv>ATR</span> <span class=o>=</span> 3b888001000000009171710098, <span class=nv>FCI</span> <span class=o>=</span> R-APDU: <span class=o>{</span><span class=nv>STATUS</span> <span class=o>=</span> SUCCESS,
</span></span><span class=line><span class=cl>    BYTES <span class=o>(</span>27<span class=o>)</span> <span class=o>=</span> 6f238409315449432e49434131a516bf0c13c70800000000c17be1f653070a3c23051410019000<span class=o>}</span>, <span class=nv>HASMATCHED</span> <span class=o>=</span> 1<span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=nv>CHANNELWASOPEN</span> <span class=o>=</span> 0<span class=o>}</span>
</span></span><span class=line><span class=cl>Application Serial <span class=nv>Number</span> <span class=o>=</span> 00000000C17BE1F6
</span></span><span class=line><span class=cl>Discretionary <span class=nv>Data</span> <span class=o>=</span> 0a3c2305141001
</span></span><span class=line><span class=cl>The selection of the PO has <span class=nv>succeeded</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                            2nd PO <span class=nv>exchange</span>                               <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                     Open a Calypso secure <span class=nv>session</span>                        <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                  Reading of Environment file <span class=o>(</span><span class=nv>SFI</span><span class=o>=</span>07h<span class=o>)</span>                   <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processSeRequest</span> <span class=o>=</span>&gt; Logical channel <span class=nv>open</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processApduRequest</span> <span class=o>=</span>&gt; APDUREQUEST: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> Select Diversifier,
</span></span><span class=line><span class=cl>    <span class=nv>RAWDATA</span> <span class=o>=</span> 801400000800000000c17be1f6, <span class=nv>CASE4</span> <span class=o>=</span> 0<span class=o>}</span>, elapsed <span class=m>208</span> ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> transmitApdu - c-apdu &gt;&gt; 801400000800000000c17be1f6
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> transmitApdu - r-apdu <span class=s>&lt;&lt; 9000
</span></span></span><span class=line><span class=cl><span class=s>[OMNIKEY CardMan (076B:5421) 5421(1)] processApduRequest =&gt; R-APDU: {STATUS = SUCCESS, BYTES (2) =
</span></span></span><span class=line><span class=cl><span class=s>    9000</span><span class=o>}</span>, elapsed <span class=m>37</span> ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processApduRequest</span> <span class=o>=</span>&gt; APDUREQUEST: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> Get Challenge,
</span></span><span class=line><span class=cl>    <span class=nv>RAWDATA</span> <span class=o>=</span>  8084000004, <span class=nv>CASE4</span> <span class=o>=</span> 0<span class=o>}</span>, elapsed <span class=m>0</span> ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> transmitApdu - c-apdu &gt;&gt; <span class=m>8084000004</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> transmitApdu - r-apdu <span class=s>&lt;&lt; ef48651d9000
</span></span></span><span class=line><span class=cl><span class=s>[OMNIKEY CardMan (076B:5421) 5421(1)] processApduRequest =&gt; R-APDU: {STATUS = SUCCESS, BYTES (6) =
</span></span></span><span class=line><span class=cl><span class=s>    ef48651d9000</span><span class=o>}</span>, elapsed <span class=m>3</span> ms
</span></span><span class=line><span class=cl>identification: <span class=nv>TERMINALCHALLENGE</span> <span class=o>=</span> ef48651d
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>processSeRequest</span> <span class=o>=</span>&gt; Logical channel <span class=nv>open</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>processApduRequest</span> <span class=o>=</span>&gt; APDUREQUEST: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> Open Secure Session
</span></span><span class=line><span class=cl>    V3.1 -  <span class=nv>KEYINDEX</span><span class=o>=</span>3, <span class=nv>SFI</span><span class=o>=</span>07, <span class=nv>REC</span><span class=o>=</span>1, <span class=nv>RAWDATA</span> <span class=o>=</span> 008a0b3904ef48651d00, <span class=nv>CASE4</span> <span class=o>=</span> 1<span class=o>}</span>, elapsed c7 ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> transmitApdu - c-apdu &gt;&gt; 008a0b3904ef48651d00
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> transmitApdu - r-apdu <span class=s>&lt;&lt;
</span></span></span><span class=line><span class=cl><span class=s>    030ab2cf0030791d00000000000000000000000000000000000000000000000000000000009000
</span></span></span><span class=line><span class=cl><span class=s>[OMNIKEY CardMan (076B:5421) 5421(2)] processApduRequest =&gt; R-APDU: {STATUS = SUCCESS, BYTES (39) = 030ab2cf0030791d00000000000000000000000000000000000000000000000000000000009000</span><span class=o>}</span>, elapsed e ms
</span></span><span class=line><span class=cl><span class=nv>processAtomicOpening</span> <span class=o>=</span>&gt; opening: <span class=nv>CARDCHALLENGE</span> <span class=o>=</span> CF, <span class=nv>POKIF</span> <span class=o>=</span> 30, <span class=nv>POKVC</span> <span class=o>=</span> <span class=m>79</span>
</span></span><span class=line><span class=cl>initialize: <span class=nv>POREVISION</span> <span class=o>=</span> REV3_1, <span class=nv>SAMREVISION</span> <span class=o>=</span> C1, <span class=nv>SESSIONENCRYPTION</span> <span class=o>=</span> 0, <span class=nv>VERIFICATIONMODE</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>initialize: <span class=nv>VERIFICATIONMODE</span> <span class=o>=</span> 0, <span class=nv>REV32MODE</span> <span class=o>=</span> 0, <span class=nv>KEYRECNUMBER</span> <span class=o>=</span> 0<span class=o>(</span>0x00<span class=o>)</span>
</span></span><span class=line><span class=cl>initialize: <span class=nv>KIF</span> <span class=o>=</span> 48<span class=o>(</span>0x30<span class=o>)</span>, <span class=nv>KVC</span> <span class=o>=</span> 79<span class=o>(</span>0x79<span class=o>)</span>, <span class=nv>DIGESTDATA</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    030ab2cf0030791d0000000000000000000000000000000000000000000000000000000000
</span></span><span class=line><span class=cl>File Environment log: <span class=nv>0000000000000000000000000000000000000000000000000000000000</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                            3th PO <span class=nv>exchange</span>                               <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                     Close the Calypso secure <span class=nv>session</span>                     <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processSeRequest</span> <span class=o>=</span>&gt; Logical channel <span class=nv>open</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processApduRequest</span> <span class=o>=</span>&gt; APDUREQUEST: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> Digest Init, <span class=nv>RAWDATA</span> <span class=o>=</span> 808a00ff273079030ab2cf0030791d0000000000000000000000000000000000000000000000000000000000, <span class=nv>CASE4</span> <span class=o>=</span> 0<span class=o>}</span>,
</span></span><span class=line><span class=cl>    elapsed 2f ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> transmitApdu - c-apdu &gt;&gt;
</span></span><span class=line><span class=cl>    808a00ff273079030ab2cf0030791d0000000000000000000000000000000000000000000000000000000000
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> transmitApdu - r-apdu <span class=s>&lt;&lt; 9000
</span></span></span><span class=line><span class=cl><span class=s>[OMNIKEY CardMan (076B:5421) 5421(1)] processApduRequest =&gt; R-APDU: {STATUS = SUCCESS, BYTES (2) = 9000</span><span class=o>}</span>,
</span></span><span class=line><span class=cl>    elapsed <span class=m>6</span> ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processApduRequest</span> <span class=o>=</span>&gt; APDUREQUEST: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> Digest Close,
</span></span><span class=line><span class=cl>    <span class=nv>RAWDATA</span> <span class=o>=</span> 808e000004, <span class=nv>CASE4</span> <span class=o>=</span> 0<span class=o>}</span>, elapsed <span class=m>0</span> ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> transmitApdu - c-apdu &gt;&gt; 808e000004
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> transmitApdu - r-apdu <span class=s>&lt;&lt; 819e515d9000
</span></span></span><span class=line><span class=cl><span class=s>[OMNIKEY CardMan (076B:5421) 5421(1)] processApduRequest =&gt; R-APDU: {STATUS = SUCCESS, BYTES (6) =
</span></span></span><span class=line><span class=cl><span class=s>    819e515d9000</span><span class=o>}</span>, elapsed <span class=m>9</span> ms
</span></span><span class=line><span class=cl><span class=nv>SIGNATURE</span> <span class=o>=</span> 819e515d
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>processSeRequest</span> <span class=o>=</span>&gt; Logical channel <span class=nv>open</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>processApduRequest</span> <span class=o>=</span>&gt; APDUREQUEST: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> Close Secure Session,
</span></span><span class=line><span class=cl>    <span class=nv>RAWDATA</span> <span class=o>=</span> 008e800004819e515d00, <span class=nv>CASE4</span> <span class=o>=</span> 1<span class=o>}</span>, elapsed <span class=m>31</span> ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> transmitApdu - c-apdu &gt;&gt; 008e800004819e515d00
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> transmitApdu - r-apdu <span class=s>&lt;&lt; 08d222e99000
</span></span></span><span class=line><span class=cl><span class=s>[OMNIKEY CardMan (076B:5421) 5421(2)] processApduRequest =&gt; R-APDU: {STATUS = SUCCESS, BYTES (6) =
</span></span></span><span class=line><span class=cl><span class=s>    08d222e99000</span><span class=o>}</span>, elapsed <span class=m>34</span> ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>processApduRequest</span> <span class=o>=</span>&gt; APDUREQUEST: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> , <span class=nv>RAWDATA</span> <span class=o>=</span> 00b2000000,
</span></span><span class=line><span class=cl>    <span class=nv>CASE4</span> <span class=o>=</span> 0<span class=o>}</span>, elapsed <span class=m>0</span> ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> transmitApdu - c-apdu &gt;&gt; 00b2000000
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> transmitApdu - r-apdu <span class=s>&lt;&lt; 6b00
</span></span></span><span class=line><span class=cl><span class=s>[OMNIKEY CardMan (076B:5421) 5421(2)] processApduRequest =&gt; R-APDU: {STATUS = FAILURE, BYTES (2) = 6b00</span><span class=o>}</span>,
</span></span><span class=line><span class=cl>    elapsed 2a ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> closePhysicalChannel
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> closeAndDisconnect - reset: y
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>2<span class=o>)]</span> <span class=nv>Ignore</span> <span class=o>=</span>&gt;  Event SE_PROCESSED received in currentState
</span></span><span class=line><span class=cl>    WAIT_FOR_START_DETECTION
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processSeRequest</span> <span class=o>=</span>&gt; Logical channel <span class=nv>open</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> <span class=nv>processApduRequest</span> <span class=o>=</span>&gt; APDUREQUEST: <span class=o>{</span><span class=nv>NAME</span> <span class=o>=</span> Digest Authenticate,
</span></span><span class=line><span class=cl>    <span class=nv>RAWDATA</span> <span class=o>=</span> 808200000408d222e9, <span class=nv>CASE4</span> <span class=o>=</span> 0<span class=o>}</span>, elapsed <span class=m>61</span> ms
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> transmitApdu - c-apdu &gt;&gt; 808200000408d222e9
</span></span><span class=line><span class=cl><span class=o>[</span>OMNIKEY CardMan <span class=o>(</span>076B:5421<span class=o>)</span> 5421<span class=o>(</span>1<span class=o>)]</span> transmitApdu - r-apdu <span class=s>&lt;&lt; 9000
</span></span></span><span class=line><span class=cl><span class=s>[OMNIKEY CardMan (076B:5421) 5421(1)] processApduRequest =&gt; R-APDU: {STATUS = SUCCESS, BYTES (2) = 9000</span><span class=o>}</span>,
</span></span><span class=line><span class=cl>    elapsed 5e <span class=nv>ms</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span><span class=line><span class=cl><span class=o>=</span>              The Calypso secure session ended <span class=nv>successfully</span>               <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                   <span class=o>(</span>Successful mutual authentication<span class=o>)</span>                     <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>=</span>                    End of the Calypso PO <span class=nv>processing</span>                      <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=o>============================================================================</span>
</span></span></code></pre></div></article><div class=article-widget><div class=post-nav><div class=post-nav-item><div class=meta-nav>Previous</div><a href=../../../../archives/docs-1.0/build-your-first-app/android-app/ rel=next>Build your first Android application</a></div></div></div></div><div class=body-footer><p>Last updated on 2024-05-03</p></div><footer class=site-footer><div class=container><div class="row featurette"><div class="col-12 col-sm-4"><p style=color:#fff><b>ECLIPSE LEGAL</b></p><a href=https://www.eclipse.org/legal/privacy.php>Privacy Policy</a><br><a href=https://www.eclipse.org/legal/termsofuse.php>Terms of Use</a><br><a href=https://www.eclipse.org/legal/copyright.php>Copyright Agent</a><br><a href=https://www.eclipse.org/legal/epl-2.0/>Eclipse Public License</a><br><a href=https://www.eclipse.org/legal/>Legal Resources</a><br><a href=https://eclipse.org/security/ target=_blank>Report a Vulnerability</a><br></div><div class="col-12 col-sm-4"><a href=https://www.eclipse.org target=_blank><img src=../../../../media/eclipse_foundation_logo.svg id=logo-eclipse-foundation></a></div><div class="col-12 col-sm-4"><a href=https://iot.eclipse.org target=_blank><img src=../../../../media/eclipse_iot_logo.svg id=logo-eclipse-iot></a></div></div></div><p class="powered-by copyright-license-text">息 2019-2024 The Eclipse Keyple速 project. All Rights Reserved.</p><p class=powered-by id=template-info>Published with <a href="https://hugoblox.com/?utm_campaign=poweredby" target=_blank rel=noopener>Hugo Blox Builder</a>  the free, <a href=https://github.com/HugoBlox/hugo-blox-builder target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></main></div></div></div><div class=page-footer></div><script src=../../../../js/vendor-bundle.min.938a3a7554cd9f6602290411f64d2617.js></script><script src=https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.min.js integrity crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/anchor-js@5.0.0/anchor.min.js integrity="sha256-aQmOEF2ZD4NM/xt4hthzREIo/2PFkOX/g01WjxEV7Ys=" crossorigin=anonymous></script><script>anchors.add()</script><script id=search-hit-fuse-template type=text/x-template>
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script><script id=page-data type=application/json>{"use_headroom":false}</script><script src=../../../../en/js/wowchemy.min.bccd04d7cb801d01ce7db1db0a676636.js></script><script src=../../../../js/wowchemy-map.a26e9d2f7238ba5b868384f1c5bc6477.js type=module></script><link rel=stylesheet href=https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css><script src=https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js></script><script src=https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js></script><script src=https://d3js.org/d3.v6.min.js></script></body></html>